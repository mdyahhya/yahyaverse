<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallConnect - Professional Video Calls</title>
    
    <!-- Supabase CDN -->
    

    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            margin: 0;
        }

        .mobile-container {
            width: 100%;
            max-width: 375px;
            height: 100vh;
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .status-bar {
            height: 44px;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }

        .app-content {
            height: calc(100vh - 44px);
            overflow-y: auto;
            padding: 0;
        }

        .page {
            display: none;
            height: 100%;
        }

        .page.active {
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 2rem 1.5rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .form-container {
            padding: 1.5rem;
            flex: 1;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e8ecef;
            border-radius: 12px;
            font-size: 1rem;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            width: 100%;
            background: #667eea;
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .text-center {
            text-align: center;
        }

        .link {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .link:hover {
            text-decoration: underline;
        }

        .user-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: #667eea;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .user-id {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .section {
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            padding-left: 0.5rem;
        }

        .call-history {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid #667eea;
        }

        .call-history:empty::after {
            content: "No call history yet";
            color: #6c757d;
            font-style: italic;
            text-align: center;
            display: block;
            padding: 1rem;
        }

        .call-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .call-item:last-child {
            border-bottom: none;
        }

        .call-info {
            flex: 1;
        }

        .call-user {
            font-weight: 500;
            color: #333;
        }

        .call-time {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .call-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .call-status-badge.accepted {
            background: #d4edda;
            color: #155724;
        }

        .call-status-badge.ended {
            background: #f8d7da;
            color: #721c24;
        }

        .video-container {
            position: relative;
            height: 60vh;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .local-video {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 100px;
            height: 130px;
            border-radius: 8px;
            border: 2px solid white;
            z-index: 10;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .control-btn.mute {
            background: #6c757d;
            color: white;
        }

        .control-btn.mute.active {
            background: #dc3545;
        }

        .control-btn.video {
            background: #6c757d;
            color: white;
        }

        .control-btn.video.active {
            background: #dc3545;
        }

        .control-btn.end {
            background: #dc3545;
            color: white;
        }

        .incoming-call {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 375px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 2rem;
        }

        .incoming-call.show {
            display: flex;
        }

        .caller-info {
            margin-bottom: 3rem;
        }

        .caller-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .incoming-text {
            font-size: 1rem;
            opacity: 0.9;
        }

        .call-actions {
            display: flex;
            gap: 2rem;
        }

        .call-action-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
            color: white;
        }

        .call-action-btn.accept {
            background: #28a745;
        }

        .call-action-btn.decline {
            background: #dc3545;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .online-users {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .online-user {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .online-user:last-child {
            border-bottom: none;
        }

        .user-name {
            font-weight: 500;
            color: #333;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }

        .audio-call-container {
    text-align: center;
    padding: 3rem 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    margin-bottom: 1rem;
    color: white;
}

.call-avatar {
    margin-bottom: 2rem;
}

.avatar-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin: 0 auto 1rem;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.call-status {
    font-size: 1.2rem;
    font-weight: 500;
    opacity: 0.9;
}
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Status Bar -->
        <div class="status-bar">
            <span id="statusText">CallConnect</span>
        </div>

        <!-- App Content -->
        <div class="app-content">
            <!-- Login Page -->
            <div id="loginPage" class="page active">
                <div class="header">
                    <div class="logo">📞 CallConnect</div>
                    <div class="subtitle">Secure video calls made simple</div>
                </div>
                <div class="form-container">
                    <div id="errorMessage" class="error" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <button id="loginBtn" class="btn">
                        <span class="btn-text">Sign In</span>
                    </button>
                    
                    <div class="text-center">
                        <p style="margin: 1rem 0; color: #6c757d;">Don't have an account?</p>
                        <button id="showRegisterBtn" class="btn btn-outline">Create Account</button>
                    </div>
                </div>
            </div>

            <!-- Register Page -->
            <div id="registerPage" class="page">
                <div class="header">
                    <div class="logo">📞 CallConnect</div>
                    <div class="subtitle">Create your account</div>
                </div>
                <div class="form-container">
                    <div id="registerErrorMessage" class="error" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <input type="password" id="registerPassword" placeholder="Create a password" required>
                    </div>
                    
                    <button id="registerBtn" class="btn">
                        <span class="btn-text">Create Account</span>
                    </button>
                    
                    <div class="text-center">
                        <p style="margin: 1rem 0; color: #6c757d;">Already have an account?</p>
                        <button id="showLoginBtn" class="btn btn-outline">Sign In</button>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page">
                <div class="header">
                    <div class="logo">📞 Dashboard</div>
                    <div class="subtitle">Welcome back!</div>
                </div>
                <div class="form-container">
                    <!-- User Info -->
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar"></div>
                        <div class="user-id" id="userId"></div>
                        <span class="status online" id="userStatus">Online</span>
                    </div>

                    <!-- Start Call Section -->
                    <div class="section">
                        <div class="section-title">Start a Call</div>
                        <div class="form-group">
                            <input type="text" id="callUserId" placeholder="Enter user ID to call">
                        </div>
                        <button id="startCallBtn" class="btn">Start Video Call</button>
                    </div>

                    <!-- Online Users Section -->
                    <div class="section">
                        <div class="section-title">Online Users</div>
                        <div class="online-users" id="onlineUsers">
                            <div style="text-align: center; color: #6c757d; padding: 1rem;">
                                Loading users...
                            </div>
                        </div>
                    </div>

                    <!-- Call History Section -->
                    <div class="section">
                        <div class="section-title">Recent Calls</div>
                        <div class="call-history" id="callHistory"></div>
                    </div>

                    <button id="logoutBtn" class="btn btn-danger">Sign Out</button>
                </div>
            </div>

            <!-- Call Page -->
            <div id="callPage" class="page">
                <div class="header">
                    <div class="logo">📞 In Call</div>
                    <div class="subtitle" id="callWithUser">Connecting...</div>
                </div>
                <div class="form-container">
                    <div class="audio-call-container">
    <div class="call-avatar">
        <div class="avatar-circle" id="remoteAvatar">👤</div>
        <div class="call-status" id="audioStatus">Connecting...</div>
    </div>
    <audio id="remoteAudio" autoplay></audio>
</div>
                    
                    <div class="call-controls">
    <button id="muteBtn" class="control-btn mute" title="Mute/Unmute">🎤</button>
    <button id="endCallBtn" class="control-btn end" title="End Call">📞</button>
</div>
                    
                    <button id="backToDashboardBtn" class="btn btn-secondary">Back to Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Incoming Call Overlay -->
        <div id="incomingCall" class="incoming-call">
            <div class="caller-info">
                <div class="caller-name" id="callerName">Unknown User</div>
                <div class="incoming-text">Incoming video call...</div>
            </div>
            <div class="call-actions">
                <button id="acceptCallBtn" class="call-action-btn accept">📞</button>
                <button id="declineCallBtn" class="call-action-btn decline">❌</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration
        const SUPABASE_URL = 'https://nsnacwwcrszpjmanskti.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4';
        let supabase;

        // Initialize Supabase client
        function initializeSupabase() {
            try {
                console.log("Initializing Supabase client...");
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                return true;
            } catch (error) {
                console.error("Error initializing Supabase client:", error);
                return false;
            }
        }

        // Global variables
        let currentUser = null;
        let currentCall = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let callsSubscription = null;
        let isAudioMuted = false;
        let isVideoMuted = false;

        // WebRTC configuration
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            if (!initializeSupabase()) {
                showError('Failed to initialize app. Please refresh.');
                return;
            }

            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await loadUserData(session.user);
                showPage('dashboardPage');
            }

            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Navigation
            document.getElementById('showRegisterBtn').addEventListener('click', () => showPage('registerPage'));
            document.getElementById('showLoginBtn').addEventListener('click', () => showPage('loginPage'));
            
            // Auth
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            document.getElementById('registerBtn').addEventListener('click', handleRegister);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Call actions
            document.getElementById('startCallBtn').addEventListener('click', handleStartCall);
            document.getElementById('acceptCallBtn').addEventListener('click', handleAcceptCall);
            document.getElementById('declineCallBtn').addEventListener('click', handleDeclineCall);
            document.getElementById('endCallBtn').addEventListener('click', handleEndCall);
            document.getElementById('backToDashboardBtn').addEventListener('click', () => showPage('dashboardPage'));
            
            // Call controls
            document.getElementById('muteBtn').addEventListener('click', toggleAudio);
          
            // Enter key handling
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('registerPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
            document.getElementById('callUserId').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleStartCall();
            });
        }

        async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showError('Please fill in all fields');
        return;
    }

    setLoading('loginBtn', true);
    
    try {
        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) throw error;

        await loadUserData(data.user);
        showPage('dashboardPage');
        
    } catch (error) {
        showError(error.message);
    } finally {
        setLoading('loginBtn', false);
    }
}
        async function handleAcceptCall() {
            try {
                // Update call status
                const { error } = await supabase
                    .from('calls')
                    .update({ status: 'accepted' })
                    .eq('id', currentCall.id);

                if (error) throw error;

                document.getElementById('incomingCall').classList.remove('show');
                await startCall(false);
                
            } catch (error) {
                showError('Failed to accept call: ' + error.message);
            }
        }

        async function handleDeclineCall() {
            try {
                // Update call status
                await supabase
                    .from('calls')
                    .update({ status: 'ended' })
                    .eq('id', currentCall.id);

                document.getElementById('incomingCall').classList.remove('show');
                currentCall = null;
                
            } catch (error) {
                console.error('Error declining call:', error);
            }
        }

        async function startCall(isCaller) {
            try {
                showPage('callPage');
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: false,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                // Create peer connection
                peerConnection = new RTCPeerConnection(rtcConfig);

                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle remote stream
               // Handle remote stream (audio only)
peerConnection.ontrack = (event) => {
    remoteStream = event.streams[0];
    document.getElementById('remoteAudio').srcObject = remoteStream;
    document.getElementById('audioStatus').textContent = 'Connected';
};

                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal('ice-candidate', {
                            candidate: event.candidate
                        });
                    }
                };

                // Subscribe to signaling
                subscribeToSignaling();

                if (isCaller) {
                    // Create and send offer
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    
                    sendSignal('offer', {
                        offer: offer
                    });
                }

                // Update UI
                const otherUserId = isCaller ? currentCall.receiver_id : currentCall.caller_id;
                const { data: otherUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', otherUserId)
                    .single();

                document.getElementById('callWithUser').textContent = `Call with ${otherUser.username}`;
                
            } catch (error) {
                showError('Failed to start call: ' + error.message);
                endCall();
            }
        }

        function subscribeToSignaling() {
            supabase
                .channel(`call_${currentCall.id}`)
                .on('broadcast', { event: 'signal' }, handleSignal)
                .subscribe();
        }

        async function handleSignal(payload) {
            const { type, data } = payload.payload;

            try {
                switch (type) {
                    case 'offer':
                        await peerConnection.setRemoteDescription(data.offer);
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        sendSignal('answer', { answer });
                        break;

                    case 'answer':
                        await peerConnection.setRemoteDescription(data.answer);
                        break;

                    case 'ice-candidate':
                        await peerConnection.addIceCandidate(data.candidate);
                        break;
                }
            } catch (error) {
                console.error('Error handling signal:', error);
            }
        }

        function sendSignal(type, data) {
            supabase
                .channel(`call_${currentCall.id}`)
                .send({
                    type: 'broadcast',
                    event: 'signal',
                    payload: { type, data }
                });
        }

        async function handleEndCall() {
            try {
                // Update call status
                if (currentCall) {
                    await supabase
                        .from('calls')
                        .update({ status: 'ended' })
                        .eq('id', currentCall.id);
                }

                endCall();
                
            } catch (error) {
                console.error('Error ending call:', error);
                endCall();
            }
        }

        function endCall() {
            // Clean up WebRTC
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // Clean up UI
          // Clean up UI
document.getElementById('remoteAudio').srcObject = null;
document.getElementById('audioStatus').textContent = 'Disconnected';
            document.getElementById('incomingCall').classList.remove('show');

            // Add this after setting remoteAudio srcObject
const remoteAudio = document.getElementById('remoteAudio');
remoteAudio.play().catch(e => console.log('Audio autoplay prevented:', e));

            // Reset state
            currentCall = null;
            isAudioMuted = false;
            isVideoMuted = false;
            
            document.getElementById('muteBtn').classList.remove('active');
            document.getElementById('videoBtn').classList.remove('active');

            // Return to dashboard
            showPage('dashboardPage');
            loadCallHistory();
        }
        

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isAudioMuted = !audioTrack.enabled;
                    
                    const btn = document.getElementById('muteBtn');
                    if (isAudioMuted) {
                        btn.classList.add('active');
                        btn.textContent = '🔇';
                    } else {
                        btn.classList.remove('active');
                        btn.textContent = '🎤';
                    }
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoMuted = !videoTrack.enabled;
                    
                    const btn = document.getElementById('videoBtn');
                    if (isVideoMuted) {
                        btn.classList.add('active');
                        btn.textContent = '📹';
                    } else {
                        btn.classList.remove('active');
                        btn.textContent = '📹';
                    }
                }
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // Update status bar
            const statusText = document.getElementById('statusText');
            switch (pageId) {
                case 'loginPage':
                case 'registerPage':
                    statusText.textContent = 'CallConnect';
                    break;
                case 'dashboardPage':
                    statusText.textContent = 'Dashboard';
                    break;
                case 'callPage':
                    statusText.textContent = 'In Call';
                    break;
            }
        }

        function showError(message, elementId = 'errorMessage') {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message, elementId = 'successMessage') {
            const successElement = document.getElementById(elementId);
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 3000);
            }
        }

        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const textSpan = button.querySelector('.btn-text');
            
            if (isLoading) {
                button.disabled = true;
                textSpan.innerHTML = '<span class="loading"></span>';
            } else {
                button.disabled = false;
                if (buttonId === 'loginBtn') {
                    textSpan.textContent = 'Sign In';
                } else if (buttonId === 'registerBtn') {
                    textSpan.textContent = 'Create Account';
                }
            }
        }

        // Global function to call user from online users list
        window.callUser = callUser;

        // Handle page visibility changes
        document.addEventListener('visibilitychange', async () => {
            if (currentUser) {
                const status = document.hidden ? 'offline' : 'online';
                await supabase
                    .from('users')
                    .update({ status })
                    .eq('id', currentUser.id);
                
                if (!document.hidden) {
                    loadOnlineUsers();
                }
            }
        });

        async function handleRegister() {
    const username = document.getElementById('registerUsername').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    if (!username || !email || !password) {
        showError('Please fill in all fields', 'registerErrorMessage');
        return;
    }

    setLoading('registerBtn', true);
    
    try {
        // Try to sign up
        const { error } = await supabase.auth.signUp({
            email: email,
            password: password
        });

        // Ignore confirmation errors and try to login immediately
        const { data, error: loginError } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (loginError) throw loginError;

        // Create user record (use upsert to avoid conflicts)
        const { error: dbError } = await supabase
            .from('users')
            .upsert([{
                id: data.user.id,
                username: username,
                email: email,
                status: 'online'
            }], { onConflict: 'id' });

        if (dbError) throw dbError;

        await loadUserData(data.user);
        showPage('dashboardPage');
        
    } catch (error) {
        showError(error.message, 'registerErrorMessage');
    } finally {
        setLoading('registerBtn', false);
    }
}
        async function handleLogout() {
            try {
                // Update user status to offline
                if (currentUser) {
                    await supabase
                        .from('users')
                        .update({ status: 'offline' })
                        .eq('id', currentUser.id);
                }

                // Sign out
                await supabase.auth.signOut();
                
                // Clean up
                if (callsSubscription) {
                    callsSubscription.unsubscribe();
                }
                
                currentUser = null;
                showPage('loginPage');
                
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadUserData(user) {
            currentUser = user;
            
            
            // Update user status to online
            await supabase
                .from('users')
                .update({ status: 'online' })
                .eq('id', user.id);

            // Update UI
            document.getElementById('userId').textContent = `ID: ${user.id.substring(0, 8)}`;
            document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
            
            // Load data
            await loadCallHistory();
            await loadOnlineUsers();
            
            // Subscribe to calls
            subscribeToIncomingCalls();
            // Add this line at the end of loadUserData function
            startDashboardRefresh();
        }

        async function loadCallHistory() {
            try {
                const { data, error } = await supabase
                    .from('calls')
                    .select(`
                        *,
                        caller:users!calls_caller_id_fkey(username),
                        receiver:users!calls_receiver_id_fkey(username)
                    `)
                    .or(`caller_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                const historyContainer = document.getElementById('callHistory');
                historyContainer.innerHTML = '';

                if (data.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 1rem;">No call history yet</div>';
                    return;
                }

                data.forEach(call => {
                    const isOutgoing = call.caller_id === currentUser.id;
                    const otherUser = isOutgoing ? call.receiver : call.caller;
                    
                    const callItem = document.createElement('div');
                    callItem.className = 'call-item';
                    callItem.innerHTML = `
                        <div class="call-info">
                            <div class="call-user">${otherUser.username}</div>
                            <div class="call-time">${new Date(call.created_at).toLocaleString()}</div>
                        </div>
                        <span class="call-status-badge ${call.status}">${call.status}</span>
                    `;
                    
                    historyContainer.appendChild(callItem);
                });
                
            } catch (error) {
                console.error('Error loading call history:', error);
            }
        }

        async function checkForIncomingCalls() {
    try {
        const { data, error } = await supabase
            .from('calls')
            .select('*, caller:users!calls_caller_id_fkey(username)')
            .eq('receiver_id', currentUser.id)
            .eq('status', 'initiated')
            .order('created_at', { ascending: false })
            .limit(1);

        if (error) throw error;

        if (data.length > 0 && !currentCall) {
            currentCall = data[0];
            document.getElementById('callerName').textContent = data[0].caller.username;
            document.getElementById('incomingCall').classList.add('show');
        }
    } catch (error) {
        console.error('Error checking calls:', error);
    }
}

function startDashboardRefresh() {
    setInterval(async () => {
        if (document.getElementById('dashboardPage').classList.contains('active')) {
            await loadOnlineUsers();
            await loadCallHistory();
            await checkForIncomingCalls(); // Add this line
        }
    }, 3000);
}



        async function loadOnlineUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('status', 'online')
                    .neq('id', currentUser.id);

                if (error) throw error;

                const container = document.getElementById('onlineUsers');
                container.innerHTML = '';

                if (data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #6c757d; padding: 1rem;">No other users online</div>';
                    return;
                }

                data.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'online-user';
                    userItem.innerHTML = `
                        <div class="user-name">${user.username}</div>
                        <button class="btn btn-small" onclick="callUser('${user.id}')">Call</button>
                    `;
                    container.appendChild(userItem);
                });
                
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        function startDashboardRefresh() {
    setInterval(async () => {
        if (document.getElementById('dashboardPage').classList.contains('active')) {
            await loadOnlineUsers();
            await loadCallHistory();
        }
    }, 3000); // Refresh every 3 seconds
}

        function subscribeToIncomingCalls() {
          callsSubscription = supabase
    .channel('public:calls')
    .on('postgres_changes',
        {
            event: 'INSERT',
            schema: 'public',
            table: 'calls',
            filter: `receiver_id=eq.${currentUser.id}`
        },
        handleIncomingCall
    )
                
                .on('postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'calls'
                    },
                    handleCallUpdate
                )
                .subscribe();
        }

        async function handleIncomingCall(payload) {
            const call = payload.new;
            if (call.status === 'initiated') {
                currentCall = call;
                
                // Get caller info
                const { data: caller } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', call.caller_id)
                    .single();

                document.getElementById('callerName').textContent = caller.username;
                document.getElementById('incomingCall').classList.add('show');
            }
        }

        async function handleCallUpdate(payload) {
            const call = payload.new;
            if (currentCall && call.id === currentCall.id) {
                if (call.status === 'accepted') {
                    document.getElementById('incomingCall').classList.remove('show');
                    await startCall(false);
                } else if (call.status === 'ended') {
                    endCall();
                }
            }
        }

        async function handleStartCall() {
            const userId = document.getElementById('callUserId').value.trim();
            if (!userId) {
                showError('Please enter a user ID');
                return;
            }
            
            await callUser(userId);
        }

        async function callUser(userId) {
            try {
                // Create call record
                const { data, error } = await supabase
                    .from('calls')
                    .insert([{
                        caller_id: currentUser.id,
                        receiver_id: userId,
                        status: 'initiated'
                    }])
                    .select()
                    .single();

                if (error) throw error;

                currentCall = data;
                
                // Start call as caller
                await startCall(true);
                
            } catch (error) {
                showError('Failed to start call: ' + error.message);
            }
        }

        async function handleAcceptCall() {
            try {
                // Update call status
                const { error } = await supabase
                    .from('calls')
                    .update({ status: 'accepted' })
                    .eq('id', currentCall.id);

                if (error) throw error;

                document.getElementById('incomingCall').classList.remove('show');
                await startCall(false);
                
            } catch (error) {
                showError('Failed to accept call: ' + error.message);
            }
        }

        async function handleDeclineCall() {
            try {
                // Update call status
                await supabase
                    .from('calls')
                    .update({ status: 'ended' })
                    .eq('id', currentCall.id);

                document.getElementById('incomingCall').classList.remove('show');
                currentCall = null;
                
            } catch (error) {
                console.error('Error declining call:', error);
            }
        }

        async function startCall(isCaller) {
            try {
                showPage('callPage');
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                document.getElementById('localVideo').srcObject = localStream;

                // Create peer connection
                peerConnection = new RTCPeerConnection(rtcConfig);

                // Add local stream to peer connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    remoteStream = event.streams[0];
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                };

                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        sendSignal('ice-candidate', {
                            candidate: event.candidate
                        });
                    }
                };

                // Subscribe to signaling
                subscribeToSignaling();

                if (isCaller) {
                    // Create and send offer
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    
                    sendSignal('offer', {
                        offer: offer
                    });
                }

                // Update UI
                const otherUserId = isCaller ? currentCall.receiver_id : currentCall.caller_id;
                const { data: otherUser } = await supabase
                    .from('users')
                    .select('username')
                    .eq('id', otherUserId)
                    .single();

                document.getElementById('callWithUser').textContent = `Call with ${otherUser.username}`;
                
            } catch (error) {
                showError('Failed to start call: ' + error.message);
                endCall();
            }
        }

        function subscribeToSignaling() {
            supabase
                .channel(`call_${currentCall.id}`)
                .on('broadcast', { event: 'signal' }, handleSignal)
                .subscribe();
        }

        async function handleSignal(payload) {
            const { type, data } = payload.payload;

            try {
                switch (type) {
                    case 'offer':
                        await peerConnection.setRemoteDescription(data.offer);
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        sendSignal('answer', { answer });
                        break;

                    case 'answer':
                        await peerConnection.setRemoteDescription(data.answer);
                        break;

                    case 'ice-candidate':
                        await peerConnection.addIceCandidate(data.candidate);
                        break;
                }
            } catch (error) {
                console.error('Error handling signal:', error);
            }
        }

        function sendSignal(type, data) {
            supabase
                .channel(`call_${currentCall.id}`)
                .send({
                    type: 'broadcast',
                    event: 'signal',
                    payload: { type, data }
                });
        }

        async function handleEndCall() {
            try {
                // Update call status
                if (currentCall) {
                    await supabase
                        .from('calls')
                        .update({ status: 'ended' })
                        .eq('id', currentCall.id);
                }

                endCall();
                
            } catch (error) {
                console.error('Error ending call:', error);
                endCall();
            }
        }

        function endCall() {
            // Clean up WebRTC
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // Clean up UI
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('incomingCall').classList.remove('show');

            // Reset state
            currentCall = null;
            isAudioMuted = false;
            isVideoMuted = false;
            
            document.getElementById('muteBtn').classList.remove('active');
            document.getElementById('videoBtn').classList.remove('active');

            // Return to dashboard
            showPage('dashboardPage');
            loadCallHistory();
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isAudioMuted = !audioTrack.enabled;
                    
                    const btn = document.getElementById('muteBtn');
                    if (isAudioMuted) {
                        btn.classList.add('active');
                        btn.textContent = '🔇';
                    } else {
                        btn.classList.remove('active');
                        btn.textContent = '🎤';
                    }
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoMuted = !videoTrack.enabled;
                    
                    const btn = document.getElementById('videoBtn');
                    if (isVideoMuted) {
                        btn.classList.add('active');
                        btn.textContent = '📹';
                    } else {
                        btn.classList.remove('active');
                        btn.textContent = '📹';
                    }
                }
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            // Update status bar
            const statusText = document.getElementById('statusText');
            switch (pageId) {
                case 'loginPage':
                case 'registerPage':
                    statusText.textContent = 'CallConnect';
                    break;
                case 'dashboardPage':
                    statusText.textContent = 'Dashboard';
                    break;
                case 'callPage':
                    statusText.textContent = 'In Call';
                    break;
            }
        }

        function showError(message, elementId = 'errorMessage') {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message, elementId = 'successMessage') {
            const successElement = document.getElementById(elementId);
            if (successElement) {
                successElement.textContent = message;
                successElement.style.display = 'block';
                setTimeout(() => {
                    successElement.style.display = 'none';
                }, 3000);
            }
        }

        function setLoading(buttonId, isLoading) {
            const button = document.getElementById(buttonId);
            const textSpan = button.querySelector('.btn-text');
            
            if (isLoading) {
                button.disabled = true;
                textSpan.innerHTML = '<span class="loading"></span>';
            } else {
                button.disabled = false;
                if (buttonId === 'loginBtn') {
                    textSpan.textContent = 'Sign In';
                } else if (buttonId === 'registerBtn') {
                    textSpan.textContent = 'Create Account';
                }
            }
        }

        // Global function to call user from online users list
        window.callUser = callUser;

        // Handle page visibility changes
        document.addEventListener('visibilitychange', async () => {
            if (currentUser) {
                const status = document.hidden ? 'offline' : 'online';
                await supabase
                    .from('users')
                    .update({ status })
                    .eq('id', currentUser.id);
                
                if (!document.hidden) {
                    loadOnlineUsers();
                }
            }
        });

        // Handle beforeunload
window.addEventListener('beforeunload', () => {
    if (currentUser) {
        supabase
            .from('users')
            .update({ status: 'offline' })
            .eq('id', currentUser.id);
    }
});
    </script>
</body>
</html>
