<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wall Decor Visualizer Pro</title>

    <!-- Fabric.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            overflow: hidden;
            height: 100vh;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: #ffffff;
            border-right: 1px solid #e5e5e5;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: #666;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Upload Section */
        .upload-section {
            margin-bottom: 24px;
        }

        .upload-btn {
            width: 100%;
            padding: 16px;
            background: #1a1a1a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upload-btn:hover {
            background: #333;
            transform: translateY(-1px);
        }

        .upload-btn:active {
            transform: translateY(0);
        }

        .upload-btn svg {
            width: 20px;
            height: 20px;
        }

        #fileInput {
            display: none;
        }

        /* Category Sections */
        .category-section {
            margin-bottom: 32px;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            cursor: pointer;
            user-select: none;
        }

        .category-title {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .category-count {
            font-size: 12px;
            color: #999;
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .product-item {
            aspect-ratio: 1;
            background: #f9f9f9;
            border: 2px solid #e5e5e5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
        }

        .product-item:hover {
            border-color: #1a1a1a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .product-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 12px;
        }

        /* Canvas Area */
        .canvas-container-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            position: relative;
        }

        .canvas-toolbar {
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: #f5f5f5;
            border-color: #1a1a1a;
        }

        .toolbar-btn.danger {
            color: #dc2626;
        }

        .toolbar-btn.primary {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .toolbar-btn.primary:hover {
            background: #333;
        }

        /* Realism Controls */
        .realism-controls {
            padding: 16px 20px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
            display: none;
        }

        .realism-controls.active {
            display: block;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: #666;
        }

        .control-value {
            font-weight: 600;
            color: #1a1a1a;
        }

        .control-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e5e5e5;
            outline: none;
            -webkit-appearance: none;
        }

        .control-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1a1a1a;
            cursor: pointer;
        }

        .control-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #1a1a1a;
            cursor: pointer;
            border: none;
        }

        /* Canvas Wrapper */
        .canvas-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: auto;
        }

        #canvas {
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            border-radius: 4px;
        }

        /* Empty State */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #666;
        }

        .empty-state p {
            font-size: 14px;
            color: #999;
        }

        /* Floating Action Buttons (Mobile) */
        .fab-container {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            flex-direction: column;
            gap: 12px;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #1a1a1a;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        .fab:hover {
            transform: scale(1.05);
        }

        .fab svg {
            width: 24px;
            height: 24px;
        }

        /* Mobile Drawer */
        .mobile-drawer {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 24px rgba(0,0,0,0.1);
            z-index: 200;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s ease;
            max-height: 70vh;
        }

        .mobile-drawer.open {
            transform: translateY(0);
        }

        .drawer-handle {
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 12px auto;
        }

        .drawer-content {
            padding: 0 20px 20px;
            overflow-y: auto;
            max-height: calc(70vh - 80px);
        }

        /* Fullscreen Mode */
        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
        }

        .spinner.active {
            display: block;
        }

        .spinner-circle {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e5e5;
            border-top-color: #1a1a1a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: 4px 0 12px rgba(0,0,0,0.1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .canvas-wrapper {
                padding: 20px;
            }

            .fab-container {
                display: flex;
            }

            .mobile-drawer {
                display: block;
            }

            .canvas-toolbar {
                flex-wrap: wrap;
            }

            .toolbar-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            background: #1a1a1a;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10001;
        }

        .tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>Wall Decor Visualizer</h1>
                <p>Design your perfect wall setup</p>
            </div>

            <div class="sidebar-content">
                <!-- Upload Section -->
                <div class="upload-section">
                    <button class="upload-btn" onclick="triggerFileUpload()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        Upload Wall Photo
                    </button>
                    <input type="file" id="fileInput" accept="image/*" capture="environment" onchange="handleImageUpload(event)">
                </div>

                <!-- Metal Wall Art -->
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">üé® Metal Wall Art</span>
                        <span class="category-count">6 items</span>
                    </div>
                    <div class="category-grid" id="artGrid"></div>
                </div>

                <!-- Metal Wall Clock -->
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">üïê Metal Wall Clock</span>
                        <span class="category-count">6 items</span>
                    </div>
                    <div class="category-grid" id="clockGrid"></div>
                </div>

                <!-- Metal Wall Mirror -->
                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">ü™û Metal Wall Mirror</span>
                        <span class="category-count">6 items</span>
                    </div>
                    <div class="category-grid" id="mirrorGrid"></div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-container-wrapper">
            <!-- Toolbar -->
            <div class="canvas-toolbar">
                <button class="toolbar-btn" onclick="undoAction()" title="Undo">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/>
                    </svg>
                    Undo
                </button>
                <button class="toolbar-btn" onclick="redoAction()" title="Redo">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6M3 17a9 9 0 019-9 9 9 0 016 2.3l3 2.7"/>
                    </svg>
                    Redo
                </button>
                <button class="toolbar-btn danger" onclick="deleteSelected()" title="Delete Selected">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Delete
                </button>
                <button class="toolbar-btn" onclick="toggleRealism()" title="Realism Controls">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6M5.6 5.6l4.2 4.2m4.2 4.2l4.2 4.2M1 12h6m6 0h6M5.6 18.4l4.2-4.2m4.2-4.2l4.2-4.2"/>
                    </svg>
                    Effects
                </button>
                <button class="toolbar-btn" onclick="resetCanvas()" title="Reset All">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 4v6h6M23 20v-6h-6"/>
                        <path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/>
                    </svg>
                    Reset
                </button>
                <button class="toolbar-btn primary" onclick="exportImage()" title="Export Image">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5 5-5-5m5-4v12"/>
                    </svg>
                    Export
                </button>
                <button class="toolbar-btn" onclick="toggleFullscreen()" title="Fullscreen Preview">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                    </svg>
                </button>
            </div>

            <!-- Realism Controls -->
            <div class="realism-controls" id="realismControls">
                <div class="control-group">
                    <div class="control-label">
                        <span>Shadow Intensity</span>
                        <span class="control-value" id="shadowValue">20</span>
                    </div>
                    <input type="range" class="control-slider" min="0" max="50" value="20" id="shadowSlider" oninput="updateShadow(this.value)">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Opacity</span>
                        <span class="control-value" id="opacityValue">100%</span>
                    </div>
                    <input type="range" class="control-slider" min="50" max="100" value="100" id="opacitySlider" oninput="updateOpacity(this.value)">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Brightness</span>
                        <span class="control-value" id="brightnessValue">0</span>
                    </div>
                    <input type="range" class="control-slider" min="-50" max="50" value="0" id="brightnessSlider" oninput="updateBrightness(this.value)">
                </div>
            </div>

            <!-- Canvas Wrapper -->
            <div class="canvas-wrapper">
                <canvas id="canvas"></canvas>
                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <path d="M21 15l-5-5L5 21"/>
                    </svg>
                    <h3>Upload a wall photo to begin</h3>
                    <p>Click the upload button or drag & drop an image</p>
                </div>
            </div>
        </main>

        <!-- Mobile Drawer -->
        <div class="mobile-drawer" id="mobileDrawer">
            <div class="drawer-handle" onclick="toggleDrawer()"></div>
            <div class="drawer-content">
                <div class="upload-section">
                    <button class="upload-btn" onclick="triggerFileUpload()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
                        </svg>
                        Upload Wall Photo
                    </button>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">üé® Metal Wall Art</span>
                    </div>
                    <div class="category-grid" id="artGridMobile"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">üïê Metal Wall Clock</span>
                    </div>
                    <div class="category-grid" id="clockGridMobile"></div>
                </div>

                <div class="category-section">
                    <div class="category-header">
                        <span class="category-title">ü™û Metal Wall Mirror</span>
                    </div>
                    <div class="category-grid" id="mirrorGridMobile"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="fullscreen-close" onclick="toggleFullscreen()">√ó</button>
        <img class="fullscreen-image" id="fullscreenImage" src="" alt="Fullscreen Preview">
    </div>

    <!-- Loading Spinner -->
    <div class="spinner" id="spinner">
        <div class="spinner-circle"></div>
    </div>

    <script>
        // ===============================================
        // GLOBAL VARIABLES & CONFIGURATION
        // ===============================================

        let canvas;
        let backgroundImage = null;
        let historyStack = [];
        let historyStep = -1;
        let isHistoryAction = false;

        // Product data with placeholder images (replace with actual paths)
        const products = {
            art: [
                { id: 'art1', name: 'Abstract Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNDAiIGZpbGw9IiNmZjYzNDciLz48cmVjdCB4PSI2MCIgeT0iNjAiIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjMiLz48L3N2Zz4=' },
                { id: 'art2', name: 'Geometric Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxwb2x5Z29uIHBvaW50cz0iMTAwLDMwIDE3MCwxNzAgMzAsMTcwIiBmaWxsPSIjNGY0NmU1Ii8+PHBvbHlnb24gcG9pbnRzPSIxMDAsODAgMTQwLDEzMCA2MCwxMzAiIGZpbGw9IiNmZmMxMDciLz48L3N2Zz4=' },
                { id: 'art3', name: 'Modern Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxyZWN0IHg9IjQwIiB5PSI0MCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZWY0NDQ0Ii8+PHJlY3QgeD0iMTEwIiB5PSI0MCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjMzQ5OGRiIi8+PHJlY3QgeD0iNDAiIHk9IjExMCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjZjM5YzEyIi8+PHJlY3QgeD0iMTEwIiB5PSIxMTAiIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzJlY2M3MSIvPjwvc3ZnPg==' },
                { id: 'art4', name: 'Floral Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjcwIiByPSIyMCIgZmlsbD0iI2U3NGM3YyIvPjxjaXJjbGUgY3g9IjgwIiBjeT0iMTAwIiByPSIyMCIgZmlsbD0iI2U3NGM3YyIvPjxjaXJjbGUgY3g9IjEyMCIgY3k9IjEwMCIgcj0iMjAiIGZpbGw9IiNlNzRjN2MiLz48Y2lyY2xlIGN4PSI4MCIgY3k9IjEzMCIgcj0iMjAiIGZpbGw9IiNlNzRjN2MiLz48Y2lyY2xlIGN4PSIxMjAiIGN5PSIxMzAiIHI9IjIwIiBmaWxsPSIjZTc0YzdjIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSIxNSIgZmlsbD0iI2ZmYzEwNyIvPjwvc3ZnPg==' },
                { id: 'art5', name: 'Minimalist Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxsaW5lIHgxPSI1MCIgeTE9IjEwMCIgeDI9IjE1MCIgeTI9IjEwMCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjEwMCIgcj0iOCIgZmlsbD0iIzMzMyIvPjxjaXJjbGUgY3g9IjE1MCIgY3k9IjEwMCIgcj0iOCIgZmlsbD0iIzMzMyIvPjwvc3ZnPg==' },
                { id: 'art6', name: 'Vintage Art', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y1ZTZkMyIvPjxyZWN0IHg9IjQwIiB5PSI0MCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzhhNmQzYiIgc3Ryb2tlLXdpZHRoPSIzIi8+PHRleHQgeD0iMTAwIiB5PSIxMTAiIGZvbnQtZmFtaWx5PSJzZXJpZiIgZm9udC1zaXplPSIzMCIgZmlsbD0iIzhhNmQzYiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VjwvdGV4dD48L3N2Zz4=' }
            ],
            clock: [
                { id: 'clock1', name: 'Classic Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzMzMyIgc3Ryb2tlLXdpZHRoPSI0Ii8+PGxpbmUgeDE9IjEwMCIgeTE9IjEwMCIgeDI9IjEwMCIgeTI9IjYwIiBzdHJva2U9IiMzMzMiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGxpbmUgeDE9IjEwMCIgeTE9IjEwMCIgeDI9IjEzMCIgeTI9IjEwMCIgc3Ryb2tlPSIjMzMzIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNSIgZmlsbD0iIzMzMyIvPjwvc3ZnPg==' },
                { id: 'clock2', name: 'Modern Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiMyYzNlNTAiLz48bGluZSB4MT0iMTAwIiB5MT0iMTAwIiB4Mj0iMTAwIiB5Mj0iNjUiIHN0cm9rZT0iI2VjZjBmMSIgc3Ryb2tlLXdpZHRoPSI0IiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48bGluZSB4MT0iMTAwIiB5MT0iMTAwIiB4Mj0iMTI1IiB5Mj0iMTAwIiBzdHJva2U9IiNlY2YwZjEiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI2IiBmaWxsPSIjZWNmMGYxIi8+PC9zdmc+' },
                { id: 'clock3', name: 'Roman Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiNmNWU2ZDMiIHN0cm9rZT0iIzhhNmQzYiIgc3Ryb2tlLXdpZHRoPSIzIi8+PHRleHQgeD0iMTAwIiB5PSI1NSIgZm9udC1mYW1pbHk9InNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOGE2ZDNiIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5YSUk8L3RleHQ+PHRleHQgeD0iMTM1IiB5PSIxMDUiIGZvbnQtZmFtaWx5PSJzZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzhhNmQzYiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SUlJPC90ZXh0Pjx0ZXh0IHg9IjEwMCIgeT0iMTUwIiBmb250LWZhbWlseT0ic2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM4YTZkM2IiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlZJPC90ZXh0Pjx0ZXh0IHg9IjY1IiB5PSIxMDUiIGZvbnQtZmFtaWx5PSJzZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzhhNmQzYiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SVg8L3RleHQ+PGxpbmUgeDE9IjEwMCIgeTE9IjEwMCIgeDI9IjEwMCIgeTI9IjcwIiBzdHJva2U9IiM4YTZkM2IiIHN0cm9rZS13aWR0aD0iMyIvPjxsaW5lIHgxPSIxMDAiIHkxPSIxMDAiIHgyPSIxMjAiIHkyPSIxMDAiIHN0cm9rZT0iIzhhNmQzYiIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+' },
                { id: 'clock4', name: 'Digital Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxyZWN0IHg9IjQwIiB5PSI3MCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSI2MCIgZmlsbD0iIzFhMWExYSIgcng9IjgiLz48dGV4dCB4PSIxMDAiIHk9IjExNSIgZm9udC1mYW1pbHk9Im1vbm9zcGFjZSIgZm9udC1zaXplPSIzMCIgZmlsbD0iIzBmZjBiMyIgdGV4dC1hbmNob3I9Im1pZGRsZSI+MTA6MzA8L3RleHQ+PC9zdmc+' },
                { id: 'clock5', name: 'Wooden Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNjAiIGZpbGw9IiNkMmIwOGEiIHN0cm9rZT0iIzZkNTMzZCIgc3Ryb2tlLXdpZHRoPSI0Ii8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iNTUiIHI9IjMiIGZpbGw9IiM2ZDUzM2QiLz48Y2lyY2xlIGN4PSIxNDUiIGN5PSIxMDAiIHI9IjMiIGZpbGw9IiM2ZDUzM2QiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxNDUiIHI9IjMiIGZpbGw9IiM2ZDUzM2QiLz48Y2lyY2xlIGN4PSI1NSIgY3k9IjEwMCIgcj0iMyIgZmlsbD0iIzZkNTMzZCIvPjxsaW5lIHgxPSIxMDAiIHkxPSIxMDAiIHgyPSIxMDAiIHkyPSI2OCIgc3Ryb2tlPSIjNmQ1MzNkIiBzdHJva2Utd2lkdGg9IjMiLz48bGluZSB4MT0iMTAwIiB5MT0iMTAwIiB4Mj0iMTI1IiB5Mj0iMTAwIiBzdHJva2U9IiM2ZDUzM2QiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==' },
                { id: 'clock6', name: 'Art Deco Clock', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2ZmZiIvPjxwb2x5Z29uIHBvaW50cz0iMTAwLDQwIDEzNSw3NSAxMzUsMTI1IDEwMCwxNjAgNjUsMTI1IDY1LDc1IiBmaWxsPSIjZGM4YzU0IiBzdHJva2U9IiM5YTY0M2EiIHN0cm9rZS13aWR0aD0iMyIvPjxsaW5lIHgxPSIxMDAiIHkxPSIxMDAiIHgyPSIxMDAiIHkyPSI3MCIgc3Ryb2tlPSIjMmMzZTUwIiBzdHJva2Utd2lkdGg9IjMiLz48bGluZSB4MT0iMTAwIiB5MT0iMTAwIiB4Mj0iMTIwIiB5Mj0iMTAwIiBzdHJva2U9IiMyYzNlNTAiIHN0cm9rZS13aWR0aD0iMiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNSIgZmlsbD0iIzJjM2U1MCIvPjwvc3ZnPg==' }
            ],
            mirror: [
                { id: 'mirror1', name: 'Round Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9Im1pcnJvckdyYWQiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZmYiIHN0b3Atb3BhY2l0eT0iMC44Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZGRkIiBzdG9wLW9wYWNpdHk9IjAuOSIvPjwvcmFkaWFsR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iMTAwIiBjeT0iMTAwIiByPSI2MCIgZmlsbD0idXJsKCNtaXJyb3JHcmFkKSIgc3Ryb2tlPSIjYzBjMGMwIiBzdHJva2Utd2lkdGg9IjQiLz48L3N2Zz4=' },
                { id: 'mirror2', name: 'Square Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9InNxdWFyZU1pcnJvciIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZiIgc3RvcC1vcGFjaXR5PSIwLjgiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNkZGQiIHN0b3Atb3BhY2l0eT0iMC45Ii8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmYiLz48cmVjdCB4PSI0MCIgeT0iNDAiIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiBmaWxsPSJ1cmwoI3NxdWFyZU1pcnJvcikiIHN0cm9rZT0iI2MwYzBjMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+PC9zdmc+' },
                { id: 'mirror3', name: 'Oval Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9Im92YWxNaXJyb3IiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZmYiIHN0b3Atb3BhY2l0eT0iMC44Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZGRkIiBzdG9wLW9wYWNpdHk9IjAuOSIvPjwvcmFkaWFsR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZmZmIi8+PGVsbGlwc2UgY3g9IjEwMCIgY3k9IjEwMCIgcng9IjQ1IiByeT0iNjUiIGZpbGw9InVybCgjb3ZhbE1pcnJvcikiIHN0cm9rZT0iI2MwYzBjMCIgc3Ryb2tlLXdpZHRoPSI0Ii8+PC9zdmc+' },
                { id: 'mirror4', name: 'Hexagon Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImhleE1pcnJvciI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZiIgc3RvcC1vcGFjaXR5PSIwLjgiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNkZGQiIHN0b3Atb3BhY2l0eT0iMC45Ii8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmYiLz48cG9seWdvbiBwb2ludHM9IjEwMCw0MCAxNDAsNzAgMTQwLDEzMCAxMDAsMTYwIDYwLDEzMCA2MCw3MCIgZmlsbD0idXJsKCNoZXhNaXJyb3IpIiBzdHJva2U9IiNjMGMwYzAiIHN0cm9rZS13aWR0aD0iNCIvPjwvc3ZnPg==' },
                { id: 'mirror5', name: 'Sunburst Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9InN1bk1pcnJvciI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2ZmZiIgc3RvcC1vcGFjaXR5PSIwLjgiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNkZGQiIHN0b3Atb3BhY2l0eT0iMC45Ii8+PC9yYWRpYWxHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjQwIiBmaWxsPSJ1cmwoI3N1bk1pcnJvcikiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIyIi8+PGxpbmUgeDE9IjEwMCIgeTE9IjQwIiB4Mj0iMTAwIiB5Mj0iMjAiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjE0MCIgeTE9IjYwIiB4Mj0iMTU1IiB5Mj0iNDUiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjE2MCIgeTE9IjEwMCIgeDI9IjE4MCIgeTI9IjEwMCIgc3Ryb2tlPSIjZGM4YzU0IiBzdHJva2Utd2lkdGg9IjMiLz48bGluZSB4MT0iMTQwIiB5MT0iMTQwIiB4Mj0iMTU1IiB5Mj0iMTU1IiBzdHJva2U9IiNkYzhjNTQiIHN0cm9rZS13aWR0aD0iMyIvPjxsaW5lIHgxPSIxMDAiIHkxPSIxNjAiIHgyPSIxMDAiIHkyPSIxODAiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjYwIiB5MT0iMTQwIiB4Mj0iNDUiIHkyPSIxNTUiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjQwIiB5MT0iMTAwIiB4Mj0iMjAiIHkyPSIxMDAiIHN0cm9rZT0iI2RjOGM1NCIgc3Ryb2tlLXdpZHRoPSIzIi8+PGxpbmUgeDE9IjYwIiB5MT0iNjAiIHgyPSI0NSIgeTI9IjQ1IiBzdHJva2U9IiNkYzhjNTQiIHN0cm9rZS13aWR0aD0iMyIvPjwvc3ZnPg==' },
                { id: 'mirror6', name: 'Vintage Mirror', src: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cmFkaWFsR3JhZGllbnQgaWQ9InZpbnRhZ2VNaXJyb3IiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmNWU2ZDMiIHN0b3Atb3BhY2l0eT0iMC44Ii8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjZGRkIiBzdG9wLW9wYWNpdHk9IjAuOSIvPjwvcmFkaWFsR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iNDAiIHk9IjQwIiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgZmlsbD0idXJsKCN2aW50YWdlTWlycm9yKSIgc3Ryb2tlPSIjOGE2ZDNiIiBzdHJva2Utd2lkdGg9IjgiIHJ4PSI4Ii8+PHJlY3QgeD0iNTAiIHk9IjUwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjOGE2ZDNiIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=' }
            ]
        };

        // ===============================================
        // INITIALIZATION
        // ===============================================

        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            loadProducts();
            setupDragAndDrop();
            setupMobileDrawer();
        });

        function initializeCanvas() {
            canvas = new fabric.Canvas('canvas', {
                width: 800,
                height: 600,
                backgroundColor: '#f0f0f0'
            });

            // Enable object controls
            fabric.Object.prototype.transparentCorners = false;
            fabric.Object.prototype.cornerColor = '#1a1a1a';
            fabric.Object.prototype.cornerStyle = 'circle';
            fabric.Object.prototype.borderColor = '#1a1a1a';
            fabric.Object.prototype.cornerSize = 12;

            // Handle canvas state changes for history
            canvas.on('object:added', saveHistory);
            canvas.on('object:modified', saveHistory);
            canvas.on('object:removed', saveHistory);

            // Responsive canvas sizing
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const wrapper = document.querySelector('.canvas-wrapper');
            const maxWidth = wrapper.clientWidth - 80;
            const maxHeight = wrapper.clientHeight - 80;

            const aspectRatio = 4/3;
            let newWidth = Math.min(maxWidth, 800);
            let newHeight = newWidth / aspectRatio;

            if (newHeight > maxHeight) {
                newHeight = maxHeight;
                newWidth = newHeight * aspectRatio;
            }

            const scale = newWidth / 800;
            canvas.setDimensions({ width: newWidth, height: newHeight });
            canvas.setZoom(scale);
        }

        // ===============================================
        // PRODUCT LOADING
        // ===============================================

        function loadProducts() {
            loadCategory('art', 'artGrid');
            loadCategory('clock', 'clockGrid');
            loadCategory('mirror', 'mirrorGrid');

            // Load for mobile drawer too
            loadCategory('art', 'artGridMobile');
            loadCategory('clock', 'clockGridMobile');
            loadCategory('mirror', 'mirrorGridMobile');
        }

        function loadCategory(category, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            products[category].forEach(product => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `<img src="${product.src}" alt="${product.name}" draggable="false">`;
                item.onclick = () => addProductToCanvas(product);
                container.appendChild(item);
            });
        }

        // ===============================================
        // IMAGE UPLOAD
        // ===============================================

        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showSpinner();
            const reader = new FileReader();

            reader.onload = function(e) {
                fabric.Image.fromURL(e.target.result, function(img) {
                    // Scale image to fit canvas
                    const scale = Math.min(
                        canvas.width / img.width,
                        canvas.height / img.height
                    );

                    img.scale(scale);
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false
                    });

                    // Remove previous background if exists
                    if (backgroundImage) {
                        canvas.remove(backgroundImage);
                    }

                    backgroundImage = img;
                    canvas.add(img);
                    canvas.sendToBack(img);
                    canvas.renderAll();

                    hideEmptyState();
                    hideSpinner();
                    saveHistory();
                });
            };

            reader.readAsDataURL(file);
        }

        // ===============================================
        // PRODUCT PLACEMENT
        // ===============================================

        function addProductToCanvas(product) {
            showSpinner();

            fabric.Image.fromURL(product.src, function(img) {
                // Default size for products (adjust as needed)
                const maxSize = 200;
                const scale = Math.min(maxSize / img.width, maxSize / img.height);

                img.scale(scale);
                img.set({
                    left: canvas.width / (2 * canvas.getZoom()) - (img.width * scale) / 2,
                    top: canvas.height / (2 * canvas.getZoom()) - (img.height * scale) / 2,
                    shadow: new fabric.Shadow({
                        color: 'rgba(0,0,0,0.3)',
                        blur: 20,
                        offsetX: 0,
                        offsetY: 10
                    })
                });

                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();
                hideSpinner();

                // Close mobile drawer if open
                closeMobileDrawer();
            }, {
                crossOrigin: 'anonymous'
            });
        }

        // ===============================================
        // EDITING CONTROLS
        // ===============================================

        function deleteSelected() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject !== backgroundImage) {
                canvas.remove(activeObject);
                canvas.renderAll();
            }
        }

        function resetCanvas() {
            if (confirm('Are you sure you want to reset the canvas? This action cannot be undone.')) {
                canvas.clear();
                canvas.backgroundColor = '#f0f0f0';
                backgroundImage = null;
                historyStack = [];
                historyStep = -1;
                showEmptyState();
                canvas.renderAll();
            }
        }

        // ===============================================
        // HISTORY (UNDO/REDO)
        // ===============================================

        function saveHistory() {
            if (isHistoryAction) return;

            const json = JSON.stringify(canvas.toJSON());
            historyStack = historyStack.slice(0, historyStep + 1);
            historyStack.push(json);
            historyStep++;

            // Limit history to 50 steps
            if (historyStack.length > 50) {
                historyStack.shift();
                historyStep--;
            }
        }

        function undoAction() {
            if (historyStep > 0) {
                historyStep--;
                loadHistory();
            }
        }

        function redoAction() {
            if (historyStep < historyStack.length - 1) {
                historyStep++;
                loadHistory();
            }
        }

        function loadHistory() {
            isHistoryAction = true;
            const state = historyStack[historyStep];

            canvas.loadFromJSON(state, function() {
                canvas.renderAll();
                isHistoryAction = false;

                // Restore background reference
                const objects = canvas.getObjects();
                if (objects.length > 0 && !objects[0].selectable) {
                    backgroundImage = objects[0];
                }
            });
        }

        // ===============================================
        // REALISM CONTROLS
        // ===============================================

        function toggleRealism() {
            const controls = document.getElementById('realismControls');
            controls.classList.toggle('active');
        }

        function updateShadow(value) {
            document.getElementById('shadowValue').textContent = value;
            const activeObject = canvas.getActiveObject();

            if (activeObject && activeObject !== backgroundImage) {
                activeObject.set('shadow', new fabric.Shadow({
                    color: 'rgba(0,0,0,0.3)',
                    blur: parseInt(value),
                    offsetX: 0,
                    offsetY: parseInt(value) / 2
                }));
                canvas.renderAll();
            }
        }

        function updateOpacity(value) {
            document.getElementById('opacityValue').textContent = value + '%';
            const activeObject = canvas.getActiveObject();

            if (activeObject && activeObject !== backgroundImage) {
                activeObject.set('opacity', value / 100);
                canvas.renderAll();
            }
        }

        function updateBrightness(value) {
            document.getElementById('brightnessValue').textContent = value;
            const activeObject = canvas.getActiveObject();

            if (activeObject && activeObject !== backgroundImage) {
                const brightness = parseFloat(value) / 100;
                activeObject.filters = [
                    new fabric.Image.filters.Brightness({ brightness: brightness })
                ];
                activeObject.applyFilters();
                canvas.renderAll();
            }
        }

        // ===============================================
        // EXPORT & SHARING
        // ===============================================

        function exportImage() {
            // Deselect all objects before export
            canvas.discardActiveObject();
            canvas.renderAll();

            // Export as data URL
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2 // Higher resolution export
            });

            // Show export options
            showExportDialog(dataURL);
        }

        function showExportDialog(dataURL) {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                z-index: 10000;
                min-width: 300px;
            `;

            dialog.innerHTML = `
                <h3 style="margin: 0 0 16px 0; font-size: 18px;">Export Your Design</h3>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="downloadImage('${dataURL}')" class="upload-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m14-7l-5 5-5-5m5-4v12"/>
                        </svg>
                        Download PNG
                    </button>
                    <button onclick="shareToWhatsApp('${dataURL}')" class="upload-btn" style="background: #25D366;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                        </svg>
                        Share to WhatsApp
                    </button>
                    <button onclick="closeExportDialog()" class="toolbar-btn" style="width: 100%; justify-content: center;">
                        Cancel
                    </button>
                </div>
            `;

            document.body.appendChild(dialog);
            window.currentExportDialog = dialog;
        }

        function closeExportDialog() {
            if (window.currentExportDialog) {
                document.body.removeChild(window.currentExportDialog);
                window.currentExportDialog = null;
            }
        }

        function downloadImage(dataURL) {
            const link = document.createElement('a');
            link.download = `wall-decor-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
            closeExportDialog();
        }

        function shareToWhatsApp(dataURL) {
            // Convert canvas to blob and share
            fetch(dataURL)
                .then(res => res.blob())
                .then(blob => {
                    const file = new File([blob], 'wall-decor.png', { type: 'image/png' });

                    if (navigator.share && navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'My Wall Decor Design',
                            text: 'Check out my wall decor design!'
                        }).then(() => {
                            closeExportDialog();
                        }).catch(err => {
                            console.log('Share failed:', err);
                            fallbackWhatsAppShare();
                        });
                    } else {
                        fallbackWhatsAppShare();
                    }
                });
        }

        function fallbackWhatsAppShare() {
            const message = encodeURIComponent('Check out my wall decor design!');
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
            closeExportDialog();
        }

        // ===============================================
        // FULLSCREEN MODE
        // ===============================================

        function toggleFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            const img = document.getElementById('fullscreenImage');

            if (!overlay.classList.contains('active')) {
                canvas.discardActiveObject();
                canvas.renderAll();

                const dataURL = canvas.toDataURL({
                    format: 'png',
                    quality: 1
                });

                img.src = dataURL;
                overlay.classList.add('active');
            } else {
                overlay.classList.remove('active');
            }
        }

        // ===============================================
        // DRAG AND DROP
        // ===============================================

        function setupDragAndDrop() {
            const canvasWrapper = document.querySelector('.canvas-wrapper');

            canvasWrapper.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                canvasWrapper.style.background = '#e8e8e8';
            });

            canvasWrapper.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                canvasWrapper.style.background = '#fafafa';
            });

            canvasWrapper.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                canvasWrapper.style.background = '#fafafa';

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    const event = { target: { files: [files[0]] } };
                    handleImageUpload(event);
                }
            });
        }

        // ===============================================
        // MOBILE DRAWER
        // ===============================================

        function setupMobileDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            const handle = drawer.querySelector('.drawer-handle');

            let startY = 0;
            let currentY = 0;

            handle.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
            });

            handle.addEventListener('touchmove', function(e) {
                currentY = e.touches[0].clientY;
                const diff = startY - currentY;

                if (diff > 50 && !drawer.classList.contains('open')) {
                    drawer.classList.add('open');
                } else if (diff < -50 && drawer.classList.contains('open')) {
                    drawer.classList.remove('open');
                }
            });
        }

        function toggleDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            drawer.classList.toggle('open');
        }

        function closeMobileDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            drawer.classList.remove('open');
        }

        // ===============================================
        // UTILITY FUNCTIONS
        // ===============================================

        function showSpinner() {
            document.getElementById('spinner').classList.add('active');
        }

        function hideSpinner() {
            document.getElementById('spinner').classList.remove('active');
        }

        function hideEmptyState() {
            document.getElementById('emptyState').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
        }

        // ===============================================
        // KEYBOARD SHORTCUTS
        // ===============================================

        document.addEventListener('keydown', function(e) {
            // Delete key
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject !== backgroundImage) {
                    e.preventDefault();
                    deleteSelected();
                }
            }

            // Ctrl/Cmd + Z (Undo)
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoAction();
            }

            // Ctrl/Cmd + Shift + Z (Redo)
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && e.shiftKey) {
                e.preventDefault();
                redoAction();
            }

            // Ctrl/Cmd + S (Export)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                exportImage();
            }
        });
    </script>
</body>
</html>
