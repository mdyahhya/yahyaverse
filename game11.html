<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: #f0f2f5;
    color: #333;
    overflow-x: hidden;
}

#app {
    position: relative;
    width: 100%;
    height: 100vh;
}

/* Screen Management */
.screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    transition: transform 0.3s ease;
}

.screen.active {
    display: flex;
    flex-direction: column;
}

/* Auth Screen */
#auth-screen {
    background: linear-gradient(135deg, #25d366, #128c7e);
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.auth-container {
    background: white;
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.logo {
    text-align: center;
    margin-bottom: 30px;
}

.logo i {
    font-size: 60px;
    color: #25d366;
    margin-bottom: 10px;
}

.logo h1 {
    color: #128c7e;
    font-size: 28px;
    font-weight: 300;
}

.auth-form {
    display: none;
}

.auth-form.active {
    display: block;
}

.auth-form h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #333;
    font-weight: 300;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 25px;
}

.username-field {
    position: relative;
}

.username-field input {
    padding-right: 40px;
}

.status-indicator {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    font-weight: bold;
}

.status-indicator.valid {
    color: #25d366;
}

.status-indicator.invalid {
    color: #dc3545;
}

.username-hint {
    font-size: 12px;
    color: #666;
    margin-top: -10px;
}

input, textarea {
    padding: 15px;
    border: 2px solid #e1e8ed;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s ease;
    font-family: inherit;
}

input:focus, textarea:focus {
    outline: none;
    border-color: #25d366;
}

.btn-primary {
    background: #25d366;
    color: white;
    border: none;
    padding: 15px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 100%;
}

.btn-primary:hover {
    background: #128c7e;
}

.btn-primary:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.auth-form p {
    text-align: center;
    margin-top: 20px;
    color: #666;
}

.auth-form a {
    color: #25d366;
    text-decoration: none;
    font-weight: 500;
}

.auth-form a:hover {
    text-decoration: underline;
}

/* Profile Setup */
#profile-setup {
    background: #f0f2f5;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.profile-container {
    background: white;
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
}

.profile-container h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #333;
}

.avatar-selection h3 {
    margin-bottom: 20px;
    color: #333;
    text-align: center;
}

.avatar-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
    max-height: 300px;
    overflow-y: auto;
}

.avatar-option {
    cursor: pointer;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid transparent;
    transition: border-color 0.3s ease;
}

.avatar-option:hover {
    border-color: #25d366;
}

.avatar-option.selected {
    border-color: #25d366;
    box-shadow: 0 0 15px rgba(37, 211, 102, 0.3);
}

.avatar-option img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    display: block;
}

/* Main App Header */
.app-header {
    background: #075e54;
    color: white;
    padding: 15px 20px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.header-content h1 {
    font-size: 20px;
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 15px;
}

.header-actions button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.header-actions button:hover {
    background: rgba(255, 255, 255, 0.1);
}

.tabs {
    display: flex;
    gap: 0;
}

.tab {
    flex: 1;
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 12px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.tab.active {
    color: white;
    border-bottom-color: #25d366;
}

/* Search Bar */
.search-container {
    background: white;
    padding: 15px 20px;
    border-bottom: 1px solid #e1e8ed;
    transition: all 0.3s ease;
}

.search-container.hidden {
    max-height: 0;
    padding: 0 20px;
    overflow: hidden;
}

#search-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #e1e8ed;
    border-radius: 25px;
    font-size: 14px;
}

/* Content Container */
.content-container {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.tab-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
}

.tab-content.active {
    display: flex;
}

/* Chats List */
.chats-list {
    flex: 1;
    overflow-y: auto;
    background: white;
}

.chat-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f2f5;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.chat-item:hover {
    background: #f8f9fa;
}

.chat-item img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.chat-info {
    flex: 1;
}

.chat-info h4 {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
}

.chat-info p {
    font-size: 14px;
    color: #666;
    margin-bottom: 3px;
}

.chat-info small {
    font-size: 12px;
    color: #999;
}

.chat-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 5px;
}

.chat-time {
    font-size: 12px;
    color: #999;
}

.unread-count {
    background: #25d366;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 500;
}

/* Contacts */
.contacts-header, .groups-header {
    padding: 20px;
    background: white;
    border-bottom: 1px solid #f0f2f5;
    display: flex;
    gap: 10px;
}

.btn-secondary {
    background: #f0f2f5;
    color: #333;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-secondary:hover {
    background: #e1e8ed;
}

.contacts-list, .groups-list {
    flex: 1;
    overflow-y: auto;
    background: white;
}

.contact-item, .group-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #f0f2f5;
    transition: background-color 0.3s ease;
}

.contact-item:hover, .group-item:hover {
    background: #f8f9fa;
}

.contact-item img, .group-item img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.contact-info, .group-info {
    flex: 1;
}

.contact-info h4, .group-info h4 {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
}

.contact-info p, .group-info p {
    font-size: 14px;
    color: #666;
    margin-bottom: 3px;
}

.group-info small {
    font-size: 12px;
    color: #999;
}

.btn-chat {
    background: #25d366;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.3s ease;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-chat:hover {
    background: #128c7e;
}

/* Floating Action Button */
.fab {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: #25d366;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(37, 211, 102, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
}

.fab:hover {
    background: #128c7e;
    transform: scale(1.1);
}

/* Chat Screen */
#chat-screen {
    background: #e5ddd5;
}

.chat-header {
    background: #075e54;
    color: white;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

#back-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

#back-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.chat-info {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
}

#chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.chat-info div h3 {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 2px;
}

.chat-info div span {
    font-size: 13px;
    opacity: 0.8;
}

.chat-actions {
    display: flex;
    gap: 10px;
}

.chat-actions button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.chat-actions button:hover {
    background: rgba(255, 255, 255, 0.1);
}

/* Messages Container */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="chat-bg" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="2" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23chat-bg)"/></svg>');
}

.message {
    margin-bottom: 15px;
    display: flex;
    align-items: flex-end;
    gap: 8px;
}

.message.own {
    flex-direction: row-reverse;
}

.message-bubble {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.4;
    position: relative;
}

.message.own .message-bubble {
    background: #dcf8c6;
    border-bottom-right-radius: 4px;
}

.message:not(.own) .message-bubble {
    background: white;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
    text-align: right;
}

.message.own .message-time {
    color: #4a4a4a;
}

/* Message Composer */
.message-composer {
    background: #f0f2f5;
    padding: 10px 20px;
    display: flex;
    align-items: flex-end;
    gap: 10px;
}

.composer-tools {
    display: flex;
    gap: 5px;
}

.composer-tools button {
    background: none;
    border: none;
    color: #666;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    transition: background-color 0.3s ease;
}

.composer-tools button:hover {
    background: rgba(0, 0, 0, 0.1);
}

.input-container {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 10px;
}

#message-input {
    flex: 1;
    border: none;
    background: white;
    border-radius: 20px;
    padding: 10px 15px;
    font-size: 14px;
    font-family: inherit;
    resize: none;
    max-height: 100px;
    min-height: 40px;
}

#message-input:focus {
    outline: none;
}

#send-btn {
    background: #25d366;
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease;
}

#send-btn:hover {
    background: #128c7e;
}

/* Modals */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: 15px;
    width: 100%;
    max-width: 400px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #f0f2f5;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    font-size: 18px;
    font-weight: 500;
    color: #333;
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    padding: 5px;
    line-height: 1;
}

.close-modal:hover {
    color: #333;
}

.modal-body {
    padding: 20px;
}

.modal-body input,
.modal-body textarea {
    width: 100%;
    margin-bottom: 15px;
}

.modal-body .btn-primary {
    margin-top: 10px;
}

/* Group Creation */
.group-avatar-selection {
    margin-bottom: 20px;
}

.group-avatar-selection h4 {
    margin-bottom: 15px;
    color: #333;
    text-align: center;
}

.group-image-upload {
    margin-bottom: 20px;
    text-align: center;
}

.upload-button {
    background: #f0f2f5;
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-button:hover {
    border-color: #25d366;
    background: #f8fff8;
}

.upload-button input {
    display: none;
}

.upload-text {
    color: #666;
    font-size: 14px;
}

/* Contact Requests */
.request-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f2f5;
}

.request-item:last-child {
    border-bottom: none;
}

.request-item img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.request-info {
    flex: 1;
}

.request-info h4 {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 5px;
    color: #333;
}

.request-info p {
    font-size: 14px;
    color: #666;
}

.request-actions {
    display: flex;
    gap: 10px;
}

.btn-accept {
    background: #25d366;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-accept:hover {
    background: #128c7e;
}

.btn-decline {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.btn-decline:hover {
    background: #c82333;
}

/* Responsive Design */
@media (max-width: 768px) {
    .auth-container {
        padding: 30px 20px;
    }
    
    .profile-container {
        padding: 30px 20px;
    }
    
    .avatar-grid {
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 10px;
    }
    
    .avatar-option img {
        width: 50px;
        height: 50px;
    }
    
    .modal-content {
        margin: 10px;
        max-width: none;
    }
    
    .fab {
        bottom: 15px;
        right: 15px;
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .header-content h1 {
        font-size: 18px;
    }
    
    .chat-item img,
    .contact-item img,
    .group-item img {
        width: 45px;
        height: 45px;
    }
    
    .chat-info h4,
    .contact-info h4,
    .group-info h4 {
        font-size: 15px;
    }
    
    .message-bubble {
        max-width: 85%;
    }
}

/* Loading States */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    color: #666;
}

.spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #25d366;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Online Status */
.online-indicator {
    width: 12px;
    height: 12px;
    background: #25d366;
    border-radius: 50%;
    border: 2px solid white;
    position: absolute;
    bottom: 2px;
    right: 2px;
}

.profile-pic-container {
    position: relative;
    display: inline-block;
}

/* Message Status Icons */
.message-status {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
    font-size: 12px;
    color: #666;
}

.message.own .message-status {
    color: #4a4a4a;
}

.status-sent::before {
    content: "✓";
}

.status-delivered::before {
    content: "✓✓";
}

.status-read::before {
    content: "✓✓";
    color: #25d366;
}

/* Typing Indicator */
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background: white;
    border-radius: 18px;
    margin: 10px 0;
    max-width: 80px;
}

.typing-dots {
    display: flex;
    gap: 3px;
}

.typing-dot {
    width: 6px;
    height: 6px;
    background: #666;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Error States */
.error-message {
    background: #ffe6e6;
    color: #d63031;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 14px;
    border-left: 4px solid #d63031;
}

/* Success States */
.success-message {
    background: #e6ffe6;
    color: #00b894;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 14px;
    border-left: 4px solid #00b894;
}
</style>
</head>
<body>
    <div id="app">
        <!-- Auth Screen -->
        <div id="auth-screen" class="screen active">
            <div class="auth-container">
                <div class="logo">
                    <i class="fab fa-whatsapp"></i>
                    <h1>ChatApp</h1>
                </div>
                
                <!-- Login Form -->
                <div id="login-form" class="auth-form active">
                    <h2>Welcome Back</h2>
                    <div class="input-group">
                        <input type="text" id="login-username" placeholder="Username" required>
                        <input type="password" id="login-password" placeholder="Password" required>
                    </div>
                    <button id="login-btn" class="btn-primary">Login</button>
                    <p>Don't have an account? <a href="#" id="show-signup">Sign Up</a></p>
                </div>
                
                <!-- Signup Form -->
                <div id="signup-form" class="auth-form">
                    <h2>Create Account</h2>
                    <div class="input-group">
                        <div class="username-field">
                            <input type="text" id="signup-username" placeholder="Username (e.g. john_doe.123)" required>
                            <span id="username-status" class="status-indicator"></span>
                        </div>
                        <small class="username-hint">Use letters, numbers, dots (.) and underscores (_)</small>
                        <input type="text" id="signup-display-name" placeholder="Display Name" required>
                        <input type="email" id="signup-email" placeholder="Email" required>
                        <input type="password" id="signup-password" placeholder="Password" required>
                        <textarea id="signup-about" placeholder="About (optional)" rows="2"></textarea>
                    </div>
                    <button id="signup-btn" class="btn-primary">Sign Up</button>
                    <p>Already have an account? <a href="#" id="show-login">Login</a></p>
                </div>
            </div>
        </div>

        <!-- Profile Setup -->
        <div id="profile-setup" class="screen">
            <div class="profile-container">
                <h2>Complete Your Profile</h2>
                <div class="avatar-selection">
                    <h3>Choose Your Avatar</h3>
                    <div class="avatar-grid" id="avatar-grid">
                        <!-- Avatar options will be populated here -->
                    </div>
                </div>
                <button id="complete-profile-btn" class="btn-primary">Complete Setup</button>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-screen" class="screen">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <h1>ChatApp</h1>
                    <div class="header-actions">
                        <button id="search-btn"><i class="fas fa-search"></i></button>
                        <button id="menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active" data-tab="chats">Chats</button>
                    <button class="tab" data-tab="contacts">Contacts</button>
                    <button class="tab" data-tab="groups">Groups</button>
                </div>
            </header>

            <!-- Search Bar -->
            <div id="search-bar" class="search-container hidden">
                <input type="text" id="search-input" placeholder="Search chats, contacts, groups...">
            </div>

            <!-- Content Areas -->
            <div class="content-container">
                <!-- Chats Tab -->
                <div id="chats-tab" class="tab-content active">
                    <div id="chats-list" class="chats-list">
                        <!-- Chat items will be populated here -->
                    </div>
                </div>

                <!-- Contacts Tab -->
                <div id="contacts-tab" class="tab-content">
                    <div class="contacts-header">
                        <button id="add-contact-btn" class="btn-secondary">
                            <i class="fas fa-user-plus"></i> Add Contact
                        </button>
                    </div>
                    <div id="contacts-list" class="contacts-list">
                        <!-- Contacts will be populated here -->
                    </div>
                </div>

                <!-- Groups Tab -->
                <div id="groups-tab" class="tab-content">
                    <div class="groups-header">
                        <button id="create-group-btn" class="btn-secondary">
                            <i class="fas fa-users"></i> Create Group
                        </button>
                        <button id="join-group-btn" class="btn-secondary">
                            <i class="fas fa-key"></i> Join Group
                        </button>
                    </div>
                    <div id="groups-list" class="groups-list">
                        <!-- Groups will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Floating Action Button -->
            <button id="fab" class="fab">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="screen">
            <div class="chat-header">
                <button id="back-btn"><i class="fas fa-arrow-left"></i></button>
                <div class="chat-info">
                    <img id="chat-avatar" src="" alt="">
                    <div>
                        <h3 id="chat-title">Chat Name</h3>
                        <span id="chat-status">Online</span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button><i class="fas fa-video"></i></button>
                    <button><i class="fas fa-phone"></i></button>
                    <button><i class="fas fa-ellipsis-v"></i></button>
                </div>
            </div>
            
            <div id="messages-container" class="messages-container">
                <!-- Messages will be populated here -->
            </div>
            
            <div class="message-composer">
                <div class="composer-tools">
                    <button id="emoji-btn"><i class="fas fa-smile"></i></button>
                    <button id="attach-btn"><i class="fas fa-paperclip"></i></button>
                </div>
                <div class="input-container">
                    <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                    <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Contact Modal -->
    <div id="add-contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Contact</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="contact-username" placeholder="Enter username">
                <button id="send-request-btn" class="btn-primary">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Group</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="group-image-upload">
                    <h4>Group Image</h4>
                    <div class="upload-button">
                        <input type="file" id="group-image-upload" accept="image/*">
                        <div class="upload-text">
                            <i class="fas fa-camera"></i>
                            <p>Click to upload group image</p>
                        </div>
                    </div>
                </div>
                <input type="text" id="group-name" placeholder="Group Name">
                <textarea id="group-description" placeholder="Group Description (optional)" rows="2"></textarea>
                <button id="create-group-submit" class="btn-primary">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Join Group Modal -->
    <div id="join-group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Join Group</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="group-code" placeholder="Enter 8-digit group code" maxlength="8">
                <button id="join-group-submit" class="btn-primary">Join Group</button>
            </div>
        </div>
    </div>

    <!-- Contact Requests Modal -->
    <div id="requests-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Contact Requests</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="requests-list">
                    <!-- Contact requests will be populated here -->
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/9.0.0/uuid.min.js"></script>
    
    <script>
        // Supabase initialization
        const SUPABASE_URL = 'https://nsnacwwcrszpjmanskti.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4';
        let supabase;
        
        function initializeSupabase() {
            try {
                console.log("Initializing Supabase client...");
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                return true;
            } catch (e) { 
                console.error("Error initializing Supabase client:", e); 
                return false; 
            }
        }

        // Avatar URLs (20 options for user profiles)
        const AVATAR_OPTIONS = [
            'https://i.pravatar.cc/150?img=1',
            'https://i.pravatar.cc/150?img=2',
            'https://i.pravatar.cc/150?img=3',
            'https://i.pravatar.cc/150?img=4',
            'https://i.pravatar.cc/150?img=5',
            'https://i.pravatar.cc/150?img=6',
            'https://i.pravatar.cc/150?img=7',
            'https://i.pravatar.cc/150?img=8',
            'https://i.pravatar.cc/150?img=9',
            'https://i.pravatar.cc/150?img=10',
            'https://i.pravatar.cc/150?img=11',
            'https://i.pravatar.cc/150?img=12',
            'https://i.pravatar.cc/150?img=13',
            'https://i.pravatar.cc/150?img=14',
            'https://i.pravatar.cc/150?img=15',
            'https://i.pravatar.cc/150?img=16',
            'https://i.pravatar.cc/150?img=17',
            'https://i.pravatar.cc/150?img=18',
            'https://i.pravatar.cc/150?img=19',
            'https://i.pravatar.cc/150?img=20'
        ];

        // Group avatar URLs (20 options for groups)
        const GROUP_AVATAR_OPTIONS = [
            'https://images.unsplash.com/photo-1522202176988-66273c2fd55f?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1517486808906-6ca8b3f04846?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1556075798-4825dfaaf498?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1516321497487-e288fb19713f?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1519085360753-af0119f7cbe7?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1531427186611-ecfd6d936c79?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1570295999919-56ceb5ecca61?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1487412720507-e7ab37603c6f?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=faces',
            'https://images.unsplash.com/photo-1492562080023-ab3db95bfbce?w=150&h=150&fit=crop&crop=faces'
        ];

        // Global variables
        let currentUser = null;
        let currentChat = null;
        let selectedAvatar = null;
        let selectedGroupAvatar = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
    if (!initializeSupabase()) {
        alert('Failed to initialize Supabase. Please check your configuration.');
        return;
    }
    
    // Add the new HTML structures and CSS
    updateContactsTabHTML();
    addContactsCSS();
    updateGroupsTabHTML();
    addGroupsCSS();
    
    await checkAuthState();
    setupEventListeners();
    setupContactEventListeners();
    setupGroupEventListeners(); // ADD THIS LINE
    populateAvatarOptions();
});

        // Check if user is already logged in
        // Enhanced checkAuthState function
async function checkAuthState() {
    try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            const user = await getUserProfile(session.user.id);
            if (user) {
                currentUser = user;
                
                // Ensure HTML structures exist
                updateContactsTabHTML();
                addContactsCSS();
                updateGroupsTabHTML();
                addGroupsCSS();
                addChatCSS();
                ensureChatHTML();
                
                showScreen('main-screen');
                await loadChats();
                await loadContacts();
                await loadGroups();
                
                // Start auto-refresh
                startContactRequestsAutoRefresh();
                startGroupRequestsAutoRefresh();
            }
        }
    } catch (error) {
        console.error('Error checking auth state:', error);
    }
}
        // Show specific screen
        function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
    
    // Handle auto-refresh based on screen
    if (screenId === 'main-screen') {
        startContactRequestsAutoRefresh();
        startGroupRequestsAutoRefresh();
    } else if (screenId === 'chat-screen') {
        stopContactRequestsAutoRefresh();
        stopGroupRequestsAutoRefresh();
        // Message refresh is handled separately in openGroup/startChat
    } else {
        stopContactRequestsAutoRefresh();
        stopGroupRequestsAutoRefresh();
        stopMessageRefresh();
    }
}


        // Populate avatar options
        function populateAvatarOptions() {
            const avatarGrid = document.getElementById('avatar-grid');
            const groupAvatarGrid = document.getElementById('group-avatar-grid');
            
            // User avatars
            AVATAR_OPTIONS.forEach((url, index) => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                avatarOption.innerHTML = `<img src="${url}" alt="Avatar ${index + 1}">`;
                avatarOption.addEventListener('click', () => selectAvatar(url, avatarOption));
                avatarGrid.appendChild(avatarOption);
            });

            // Group avatars
            GROUP_AVATAR_OPTIONS.forEach((url, index) => {
                const avatarOption = document.createElement('div');
                avatarOption.className = 'avatar-option';
                avatarOption.innerHTML = `<img src="${url}" alt="Group Avatar ${index + 1}">`;
                avatarOption.addEventListener('click', () => selectGroupAvatar(url, avatarOption));
                groupAvatarGrid.appendChild(avatarOption);
            });
        }

        function selectAvatar(url, element) {
            document.querySelectorAll('#avatar-grid .avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedAvatar = url;
        }

        function selectGroupAvatar(url, element) {
            document.querySelectorAll('#group-avatar-grid .avatar-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            selectedGroupAvatar = url;
        }

        // Setup event listeners
        // COMPLETE setupEventListeners function - REPLACE your existing one with this:
function setupEventListeners() {
    // Auth form toggles
    document.getElementById('show-signup')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('login-form').classList.remove('active');
        document.getElementById('signup-form').classList.add('active');
    });

    document.getElementById('show-login')?.addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('signup-form').classList.remove('active');
        document.getElementById('login-form').classList.add('active');
    });

    // Username validation
    document.getElementById('signup-username')?.addEventListener('input', debounce(checkUsernameAvailability, 500));

    // Auth buttons
    document.getElementById('signup-btn')?.addEventListener('click', handleSignup);
    document.getElementById('login-btn')?.addEventListener('click', handleLogin);
    document.getElementById('complete-profile-btn')?.addEventListener('click', completeProfile);

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Search functionality
    document.getElementById('search-btn')?.addEventListener('click', toggleSearch);
    document.getElementById('search-input')?.addEventListener('input', debounce(handleSearch, 300));

    // Modal controls
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', closeModals);
    });

    // Contact and group actions - use event delegation
    document.addEventListener('click', (e) => {
        // Contact actions
        if (e.target.id === 'add-contact-btn' || e.target.closest('#add-contact-btn')) {
            document.getElementById('add-contact-modal').style.display = 'flex';
        }
        
        // Group actions
        if (e.target.id === 'create-group-btn' || e.target.closest('#create-group-btn')) {
            document.getElementById('create-group-modal').style.display = 'flex';
        }
        
        if (e.target.id === 'join-group-btn' || e.target.closest('#join-group-btn')) {
            document.getElementById('join-group-modal').style.display = 'flex';
        }

        // Back button
        if (e.target.id === 'back-btn' || e.target.closest('#back-btn')) {
            stopMessageRefresh();
            showScreen('main-screen');
            currentChat = null;
        }

        // Send button
        if (e.target.id === 'send-btn' || e.target.closest('#send-btn')) {
            sendMessage();
        }
    });

    // Form submissions
    document.getElementById('send-request-btn')?.addEventListener('click', sendContactRequest);
    document.getElementById('create-group-submit')?.addEventListener('click', createGroup);
    document.getElementById('join-group-submit')?.addEventListener('click', joinGroup);

    // Message input handling
    document.addEventListener('keypress', (e) => {
        if (e.target.id === 'message-input' && e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize message input
    document.addEventListener('input', (e) => {
        if (e.target.id === 'message-input') {
            e.target.style.height = 'auto';
            e.target.style.height = Math.min(e.target.scrollHeight, 100) + 'px';
        }
    });

    // Group image upload
    document.getElementById('group-image-upload')?.addEventListener('change', handleGroupImageUpload);

    // Click outside modal to close
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            closeModals();
        }
    });
}

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Check username availability
        async function checkUsernameAvailability() {
            const username = document.getElementById('signup-username').value.trim();
            const statusElement = document.getElementById('username-status');
            
            if (!username) {
                statusElement.textContent = '';
                statusElement.className = 'status-indicator';
                return;
            }

            // Validate username format
            const usernameRegex = /^[a-zA-Z0-9_.]+$/;
            if (!usernameRegex.test(username)) {
                statusElement.textContent = '✗';
                statusElement.className = 'status-indicator invalid';
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // Username not found, it's available
                    statusElement.textContent = '✓';
                    statusElement.className = 'status-indicator valid';
                } else {
                    // Username exists
                    statusElement.textContent = '✗';
                    statusElement.className = 'status-indicator invalid';
                }
            } catch (error) {
                console.error('Error checking username:', error);
            }
        }

        // Handle signup
        // Handle signup
// Handle signup - FIXED VERSION with UPSERT
async function handleSignup() {
    const username = document.getElementById('signup-username').value.trim();
    const displayName = document.getElementById('signup-display-name').value.trim();
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const about = document.getElementById('signup-about').value.trim();

    if (!username || !displayName || !email || !password) {
        alert('Please fill in all required fields');
        return;
    }

    // Validate username format
    const usernameRegex = /^[a-zA-Z0-9_.]+$/;
    if (!usernameRegex.test(username)) {
        alert('Username can only contain letters, numbers, dots (.) and underscores (_)');
        return;
    }

    try {
        // Check if username is available
        const { data: existingUser } = await supabase
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();

        if (existingUser) {
            alert('Username is already taken');
            return;
        }

        // Sign up with Supabase Auth
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email: email,
            password: password
        });

        if (authError) {
            alert('Signup failed: ' + authError.message);
            return;
        }

        // FIXED: Use upsert instead of insert to handle existing profiles
        const { data: profileData, error: profileError } = await supabase
            .from('profiles')
            .upsert([
                {
                    id: authData.user.id,
                    username: username,
                    display_name: displayName,
                    email: email,
                    about: about,
                    password: password
                }
            ], {
                onConflict: 'id'
            })
            .select();

        if (profileError) {
            alert('Profile creation failed: ' + profileError.message);
            return;
        }

        // Store user data temporarily and show profile setup
        currentUser = {
            id: authData.user.id,
            username: username,
            display_name: displayName,
            email: email,
            about: about
        };

        showScreen('profile-setup');
        await loadAvatarOptions();

    } catch (error) {
        console.error('Signup error:', error);
        alert('An error occurred during signup');
    }
}
        // Handle login
        async function handleLogin() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }

            try {
                // Get user by username
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (profileError || !profile) {
                    alert('Username not found');
                    return;
                }

                // Check password (direct comparison as requested)
                if (profile.password !== password) {
                    alert('Incorrect password');
                    return;
                }

                // Sign in with email (get email from profile)
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: profile.email || `${username}@temp.com`, // Fallback email
                    password: password
                });

                if (authError) {
                    // If auth fails, create a session manually or use a different approach
                    currentUser = profile;
                    showScreen('main-screen');
                    await loadChats();
                    await loadContacts();
                    await loadGroups();
                    return;
                }

                currentUser = profile;
                showScreen('main-screen');
                await loadChats();
                await loadContacts();
                await loadGroups();

            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed');
            }
        }

        // Load avatar options from Supabase
        async function loadAvatarOptions() {
            try {
                const { data: avatars, error } = await supabase
                    .from('avatar_options')
                    .select('*')
                    .order('id');

                if (error) {
                    console.error('Error loading avatars:', error);
                    return;
                }

                const avatarGrid = document.getElementById('avatar-grid');
                avatarGrid.innerHTML = '';

                avatars.forEach(avatar => {
                    const avatarOption = document.createElement('div');
                    avatarOption.className = 'avatar-option';
                    avatarOption.innerHTML = `<img src="${avatar.url}" alt="${avatar.name}">`;
                    avatarOption.addEventListener('click', () => selectAvatar(avatar.url, avatarOption));
                    avatarGrid.appendChild(avatarOption);
                });
            } catch (error) {
                console.error('Error loading avatar options:', error);
            }
        }

        // Complete profile setup
        async function completeProfile() {
    if (!selectedAvatar) {
        alert('Please select an avatar');
        return;
    }

    try {
        const { error } = await supabase
            .from('profiles')
            .update({ avatar_url: selectedAvatar })
            .eq('id', currentUser.id);

        if (error) {
            alert('Failed to update profile: ' + error.message);
            return;
        }

        currentUser.avatar_url = selectedAvatar;
        
        // Ensure HTML structures exist
        updateContactsTabHTML();
        addContactsCSS();
        updateGroupsTabHTML();
        addGroupsCSS();
        addChatCSS();
        ensureChatHTML();
        
        showScreen('main-screen');
        await loadChats();
        await loadContacts();
        await loadGroups();
        
        // Start auto-refresh
        startContactRequestsAutoRefresh();
        startGroupRequestsAutoRefresh();

    } catch (error) {
        console.error('Profile completion error:', error);
        alert('Failed to complete profile');
    }
}

// Add a utility function to generate UUID for file uploads
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Toggle search
        function toggleSearch() {
            const searchBar = document.getElementById('search-bar');
            searchBar.classList.toggle('hidden');
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('search-input').focus();
            }
        }

        // Handle search
        function handleSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            // Implement search functionality
            console.log('Searching for:', query);
        }

        // Close modals
        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Get user profile
        async function getUserProfile(userId) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) {
                    console.error('Error fetching user profile:', error);
                    return null;
                }

                return data;
            } catch (error) {
                console.error('Error getting user profile:', error);
                return null;
            }
        }

        // Send contact request
       

        // Handle group image upload
        async function handleGroupImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${uuidv4()}.${fileExt}`;
                const filePath = `group-avatars/${fileName}`;

                const { data, error } = await supabase.storage
                    .from('avatars')
                    .upload(filePath, file);

                if (error) {
                    alert('Failed to upload image: ' + error.message);
                    return;
                }

                const { data: urlData } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(filePath);

                selectedGroupAvatar = urlData.publicUrl;
                
                // Show preview
                const preview = document.createElement('img');
                preview.src = selectedGroupAvatar;
                preview.style.width = '50px';
                preview.style.height = '50px';
                preview.style.borderRadius = '50%';
                preview.style.marginTop = '10px';
                
                const uploadContainer = event.target.parentNode;
                const existingPreview = uploadContainer.querySelector('img');
                if (existingPreview) {
                    uploadContainer.removeChild(existingPreview);
                }
                uploadContainer.appendChild(preview);

            } catch (error) {
                console.error('Error uploading group image:', error);
                alert('Failed to upload image');
            }
        }

        // Create group
        async function createGroup() {
            const groupName = document.getElementById('group-name').value.trim();
            const groupDescription = document.getElementById('group-description').value.trim();

            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            try {
                // Generate 8-digit group code
                const groupCode = Math.floor(10000000 + Math.random() * 90000000).toString();

                const { data: group, error: groupError } = await supabase
                    .from('groups')
                    .insert([
                        {
                            name: groupName,
                            description: groupDescription,
                            avatar_url: selectedGroupAvatar,
                            group_code: groupCode,
                            created_by: currentUser.id,
                            admin_id: currentUser.id
                        }
                    ])
                    .select()
                    .single();

                if (groupError) {
                    alert('Failed to create group: ' + groupError.message);
                    return;
                }

                // Add creator as member
                const { error: memberError } = await supabase
                    .from('group_members')
                    .insert([
                        {
                            group_id: group.id,
                            user_id: currentUser.id,
                            role: 'admin',
                            status: 'approved'
                        }
                    ]);

                if (memberError) {
                    console.error('Error adding creator as member:', memberError);
                }

                alert(`Group created! Group code: ${groupCode}`);
                closeModals();
                clearGroupForm();
                await loadGroups();

            } catch (error) {
                console.error('Error creating group:', error);
                alert('Failed to create group');
            }
        }

        // Join group
        async function joinGroup() {
            const groupCode = document.getElementById('group-code').value.trim();

            if (!groupCode || groupCode.length !== 8) {
                alert('Please enter a valid 8-digit group code');
                return;
            }

            try {
                // Find group by code
                const { data: group, error: groupError } = await supabase
                    .from('groups')
                    .select('*')
                    .eq('group_code', groupCode)
                    .single();

                if (groupError || !group) {
                    alert('Invalid group code');
                    return;
                }

                // Check if already a member
                const { data: existingMember, error: memberError } = await supabase
                    .from('group_members')
                    .select('*')
                    .eq('group_id', group.id)
                    .eq('user_id', currentUser.id)
                    .single();

                if (existingMember) {
                    alert('You are already a member of this group');
                    return;
                }

                // Send join request
                const { error: requestError } = await supabase
                    .from('group_members')
                    .insert([
                        {
                            group_id: group.id,
                            user_id: currentUser.id,
                            role: 'member',
                            status: 'pending'
                        }
                    ]);

                if (requestError) {
                    alert('Failed to send join request: ' + requestError.message);
                    return;
                }

                alert('Join request sent! Wait for admin approval.');
                closeModals();
                document.getElementById('group-code').value = '';

            } catch (error) {
                console.error('Error joining group:', error);
                alert('Failed to join group');
            }
        }

        // Clear group form
        function clearGroupForm() {
            document.getElementById('group-name').value = '';
            document.getElementById('group-description').value = '';
            selectedGroupAvatar = null;
            const preview = document.querySelector('#create-group-modal img');
            if (preview) preview.remove();
        }

        // Load chats
        // Enhanced loadChats function (basic implementation)
async function loadChats() {
    try {
        // This is a basic implementation - you might want to enhance this
        // to show recent conversations
        console.log('Loading chats...');
        
        // You could implement a recent conversations list here
        // For now, users can access chats through contacts and groups
        
    } catch (error) {
        console.error('Error loading chats:', error);
    }
}

// Add window beforeunload to cleanup intervals
window.addEventListener('beforeunload', () => {
    stopContactRequestsAutoRefresh();
    stopGroupRequestsAutoRefresh();
    stopMessageRefresh();
});

// Add visibility change handler to pause/resume refresh when tab is not active
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        // Resume refresh when tab becomes visible
        if (document.getElementById('main-screen')?.classList.contains('active')) {
            startContactRequestsAutoRefresh();
            startGroupRequestsAutoRefresh();
        }
        if (currentChat) {
            startMessageRefresh();
        }
    } else {
        // Pause refresh when tab is not visible to save resources
        stopContactRequestsAutoRefresh();
        stopGroupRequestsAutoRefresh();
        stopMessageRefresh();
    }
});

        // Load contacts
        async function loadContacts() {
    try {
        const { data: contacts, error } = await supabase
            .from('contacts')
            .select(`
                *,
                contact:profiles!contacts_contact_id_fkey(*)
            `)
            .eq('owner_id', currentUser.id)
            .eq('status', 'approved');

        if (error) {
            console.error('Error loading contacts:', error);
            return;
        }

        const contactsList = document.getElementById('contacts-list');
        if (contactsList) {
            contactsList.innerHTML = '';

            if (contacts.length === 0) {
                contactsList.innerHTML = '<p class="no-contacts">No contacts yet. Add some friends!</p>';
                return;
            }

            contacts.forEach(contact => {
                const contactElement = createContactElement(contact.contact);
                contactsList.appendChild(contactElement);
            });
        }

    } catch (error) {
        console.error('Error loading contacts:', error);
    }
}

        // Load groups
        async function loadGroups() {
            try {
                const { data: groups, error } = await supabase
                    .from('group_members')
                    .select(`
                        *,
                        group:groups(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'approved');

                if (error) {
                    console.error('Error loading groups:', error);
                    return;
                }

                const groupsList = document.getElementById('groups-list');
                groupsList.innerHTML = '';

                groups.forEach(groupMember => {
                    const groupElement = createGroupElement(groupMember.group);
                    groupsList.appendChild(groupElement);
                });

            } catch (error) {
                console.error('Error loading groups:', error);
            }
        }

        // Create contact element
        function createContactElement(contact) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.innerHTML = `
                <img src="${contact.avatar_url || '/default-avatar.png'}" alt="${contact.display_name}">
                <div class="contact-info">
                    <h4>${contact.display_name}</h4>
                    <p>@${contact.username}</p>
                </div>
                <button class="btn-chat" onclick="startChat('${contact.id}')">
                    <i class="fas fa-comment"></i>
                </button>
            `;
            return div;
        }

        // Create group element
        function createGroupElement(group) {
            const div = document.createElement('div');
            div.className = 'group-item';
            div.innerHTML = `
                <img src="${group.avatar_url || '/default-group.png'}" alt="${group.name}">
                <div class="group-info">
                    <h4>${group.name}</h4>
                    <p>${group.description || 'No description'}</p>
                    <small>Code: ${group.group_code}</small>
                </div>
                <button class="btn-chat" onclick="openGroup('${group.id}')">
                    <i class="fas fa-comments"></i>
                </button>
            `;
            return div;
        }

        // Start chat with contact
        async function startChat(contactId) {
    try {
        // Get contact details
        const { data: contact, error: contactError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', contactId)
            .single();

        if (contactError || !contact) {
            alert('Contact not found');
            return;
        }

        // Set current chat
        currentChat = {
            id: contactId,
            type: 'private',
            name: contact.display_name,
            avatar_url: contact.avatar_url
        };

        // Update chat header
        document.getElementById('chat-header-avatar').src = contact.avatar_url || '/default-avatar.png';
        document.getElementById('chat-header-name').textContent = contact.display_name;
        document.getElementById('chat-header-status').textContent = `@${contact.username}`;

        // Clear messages
        document.getElementById('messages-container').innerHTML = '';

        // Load messages
        await loadPrivateMessages(contactId);

        // Show chat screen
        showScreen('chat-screen');

        // Start message refresh
        startMessageRefresh();

    } catch (error) {
        console.error('Error starting chat:', error);
        alert('Failed to start chat');
    }
}

        // Open group chat
        async function openGroup(groupId) {
    try {
        // Get group details
        const { data: group, error: groupError } = await supabase
            .from('groups')
            .select('*')
            .eq('id', groupId)
            .single();

        if (groupError || !group) {
            alert('Group not found');
            return;
        }

        // Set current chat
        currentChat = {
            id: groupId,
            type: 'group',
            name: group.name,
            avatar_url: group.avatar_url
        };

        // Update chat header
        document.getElementById('chat-header-avatar').src = group.avatar_url || '/default-group.png';
        document.getElementById('chat-header-name').textContent = group.name;
        document.getElementById('chat-header-status').textContent = `Group • ${group.group_code}`;

        // Clear messages
        document.getElementById('messages-container').innerHTML = '';

        // Load messages
        await loadGroupMessages(groupId);

        // Show chat screen
        showScreen('chat-screen');

        // Start message refresh
        startMessageRefresh();

    } catch (error) {
        console.error('Error opening group:', error);
        alert('Failed to open group chat');
    }
}

async function loadGroupMessages(groupId) {
    try {
        const { data: messages, error } = await supabase
            .from('messages')
            .select(`
                *,
                sender:profiles!messages_sender_id_fkey(*)
            `)
            .eq('group_id', groupId)
            .order('created_at', { ascending: true });

        if (error) {
            console.error('Error loading group messages:', error);
            return;
        }

        const container = document.getElementById('messages-container');
        container.innerHTML = '';

        messages.forEach(message => {
            const messageElement = createMessageElement(message);
            container.appendChild(messageElement);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

    } catch (error) {
        console.error('Error loading group messages:', error);
    }
}
async function loadGroupMessages(groupId) {
    try {
        const { data: messages, error } = await supabase
            .from('messages')
            .select(`
                *,
                sender:profiles!messages_sender_id_fkey(*)
            `)
            .eq('group_id', groupId)
            .order('created_at', { ascending: true });

        if (error) {
            console.error('Error loading group messages:', error);
            return;
        }

        const container = document.getElementById('messages-container');
        container.innerHTML = '';

        messages.forEach(message => {
            const messageElement = createMessageElement(message);
            container.appendChild(messageElement);
        });

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

    } catch (error) {
        console.error('Error loading group messages:', error);
    }
}

        // Send message
        // UPDATE your sendMessage function:
async function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message || !currentChat) return;
    
    try {
        const messageData = {
            content: message,
            sender_id: currentUser.id
        };

        if (currentChat.type === 'group') {
            messageData.group_id = currentChat.id;
        } else {
            messageData.receiver_id = currentChat.id;
        }

        const { error } = await supabase
            .from('messages')
            .insert([messageData]);

        if (error) {
            alert('Failed to send message: ' + error.message);
            return;
        }

        messageInput.value = '';
        
        // Immediately reload messages
        if (currentChat.type === 'group') {
            await loadGroupMessages(currentChat.id);
        } else {
            await loadPrivateMessages(currentChat.id);
        }

    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
    }
}

        // Add this function to update your contacts tab HTML structure
function updateContactsTabHTML() {
    const contactsTab = document.getElementById('contacts-tab');
    if (contactsTab) {
        contactsTab.innerHTML = `
            <div class="contacts-header">
                <div class="contacts-nav">
                    <button class="contact-nav-btn active" data-contact-tab="contacts">My Contacts</button>
                    <button class="contact-nav-btn" data-contact-tab="received">Received (<span id="received-count">0</span>)</button>
                    <button class="contact-nav-btn" data-contact-tab="sent">Sent (<span id="sent-count">0</span>)</button>
                </div>
                <button id="add-contact-btn" class="btn-primary">
                    <i class="fas fa-user-plus"></i> Add Contact
                </button>
            </div>

            <div id="contacts-content" class="contact-tab-content active">
                <div id="contacts-list" class="contacts-list"></div>
            </div>

            <div id="received-content" class="contact-tab-content">
                <h3>Received Requests</h3>
                <div id="received-requests-list" class="requests-list"></div>
            </div>

            <div id="sent-content" class="contact-tab-content">
                <h3>Sent Requests</h3>
                <div id="sent-requests-list" class="requests-list"></div>
            </div>
        `;
    }
}

// Add CSS styles for the new structure
function addContactsCSS() {
    const style = document.createElement('style');
    style.textContent = `
        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .contacts-nav {
            display: flex;
            gap: 10px;
        }

        .contact-nav-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .contact-nav-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .contact-nav-btn:hover {
            background: #f8f9fa;
        }

        .contact-nav-btn.active:hover {
            background: #0056b3;
        }

        .contact-tab-content {
            display: none;
        }

        .contact-tab-content.active {
            display: block;
        }

        .requests-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .request-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .request-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .request-info {
            flex: 1;
        }

        .request-info h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }

        .request-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-accept {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        .request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
    `;
    document.head.appendChild(style);
}








// Global variables for auto-refresh
let contactRequestsInterval = null;
let currentContactTab = 'contacts';

// Enhanced setupEventListeners function - ADD THESE to your existing function
// function setupContactEventListeners() {
//     // Contact tab navigation
//     document.addEventListener('click', (e) => {
//         if (e.target.classList.contains('contact-nav-btn')) {
//             switchContactTab(e.target.dataset.contactTab);
//         }
//     });

//     // Add contact button (update existing listener)
//     document.getElementById('add-contact-btn').addEventListener('click', () => {
//         document.getElementById('add-contact-modal').style.display = 'flex';
//     });
// }

// Switch between contact tabs
function switchContactTab(tabName) {
    currentContactTab = tabName;
    
    // Update nav buttons
    document.querySelectorAll('.contact-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-contact-tab="${tabName}"]`).classList.add('active');
    
    // Update content
    document.querySelectorAll('.contact-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-content`).classList.add('active');
    
    // Load appropriate data
    if (tabName === 'received') {
        loadReceivedRequests();
    } else if (tabName === 'sent') {
        loadSentRequests();
    }
}

// Start auto-refresh for contact requests
function startContactRequestsAutoRefresh() {
    // Clear existing interval
    if (contactRequestsInterval) {
        clearInterval(contactRequestsInterval);
    }
    
    // Set up fast refresh every 2 seconds
    contactRequestsInterval = setInterval(() => {
        loadReceivedRequests();
        loadSentRequests();
        updateRequestCounts();
    }, 2000);
    
    // Initial load
    loadReceivedRequests();
    loadSentRequests();
    updateRequestCounts();
}

// Stop auto-refresh
function stopContactRequestsAutoRefresh() {
    if (contactRequestsInterval) {
        clearInterval(contactRequestsInterval);
        contactRequestsInterval = null;
    }
}

// Enhanced send contact request
async function sendContactRequest() {
    const username = document.getElementById('contact-username').value.trim();
    
    if (!username) {
        alert('Please enter a username');
        return;
    }

    try {
        // Find user by username
        const { data: targetUser, error: userError } = await supabase
            .from('profiles')
            .select('*')
            .eq('username', username)
            .single();

        if (userError || !targetUser) {
            alert('User not found');
            return;
        }

        if (targetUser.id === currentUser.id) {
            alert('You cannot add yourself');
            return;
        }

        // Check if request already exists
        const { data: existingRequest } = await supabase
            .from('contact_requests')
            .select('*')
            .eq('from_user_id', currentUser.id)
            .eq('to_user_id', targetUser.id)
            .single();

        if (existingRequest) {
            alert('Request already sent to this user');
            return;
        }

        // Check if they're already contacts
        const { data: existingContact } = await supabase
            .from('contacts')
            .select('*')
            .eq('owner_id', currentUser.id)
            .eq('contact_id', targetUser.id)
            .eq('status', 'approved')
            .single();

        if (existingContact) {
            alert('This user is already in your contacts');
            return;
        }

        // Send contact request
        const { error: requestError } = await supabase
            .from('contact_requests')
            .insert([
                {
                    from_user_id: currentUser.id,
                    to_user_id: targetUser.id,
                    status: 'pending'
                }
            ]);

        if (requestError) {
            alert('Failed to send request: ' + requestError.message);
            return;
        }

        alert('Contact request sent!');
        closeModals();
        document.getElementById('contact-username').value = '';
        
        // Immediately refresh sent requests
        loadSentRequests();
        updateRequestCounts();

    } catch (error) {
        console.error('Error sending contact request:', error);
        alert('Failed to send contact request');
    }
}

// Load received requests
async function loadReceivedRequests() {
    try {
        const { data: requests, error } = await supabase
            .from('contact_requests')
            .select(`
                *,
                from_user:profiles!contact_requests_from_user_id_fkey(*)
            `)
            .eq('to_user_id', currentUser.id)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading received requests:', error);
            return;
        }

        const requestsList = document.getElementById('received-requests-list');
        requestsList.innerHTML = '';

        if (requests.length === 0) {
            requestsList.innerHTML = '<p class="no-requests">No pending requests</p>';
            return;
        }

        requests.forEach(request => {
            const requestElement = createReceivedRequestElement(request);
            requestsList.appendChild(requestElement);
        });

    } catch (error) {
        console.error('Error loading received requests:', error);
    }
}

// Load sent requests
async function loadSentRequests() {
    try {
        const { data: requests, error } = await supabase
            .from('contact_requests')
            .select(`
                *,
                to_user:profiles!contact_requests_to_user_id_fkey(*)
            `)
            .eq('from_user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading sent requests:', error);
            return;
        }

        const requestsList = document.getElementById('sent-requests-list');
        requestsList.innerHTML = '';

        if (requests.length === 0) {
            requestsList.innerHTML = '<p class="no-requests">No sent requests</p>';
            return;
        }

        requests.forEach(request => {
            const requestElement = createSentRequestElement(request);
            requestsList.appendChild(requestElement);
        });

    } catch (error) {
        console.error('Error loading sent requests:', error);
    }
}

// Update request counts in navigation
async function updateRequestCounts() {
    try {
        // Get received requests count
        const { data: receivedRequests, error: receivedError } = await supabase
            .from('contact_requests')
            .select('id', { count: 'exact', head: true })
            .eq('to_user_id', currentUser.id)
            .eq('status', 'pending');

        // Get sent requests count
        const { data: sentRequests, error: sentError } = await supabase
            .from('contact_requests')
            .select('id', { count: 'exact', head: true })
            .eq('from_user_id', currentUser.id);

        if (!receivedError) {
            const receivedCount = receivedRequests || 0;
            const receivedCountElement = document.getElementById('received-count');
            if (receivedCountElement) {
                receivedCountElement.textContent = receivedCount;
            }
        }

        if (!sentError) {
            const sentCount = sentRequests || 0;
            const sentCountElement = document.getElementById('sent-count');
            if (sentCountElement) {
                sentCountElement.textContent = sentCount;
            }
        }

    } catch (error) {
        console.error('Error updating request counts:', error);
    }
}

// Create received request element
function createReceivedRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    div.innerHTML = `
        <img src="${request.from_user.avatar_url || '/default-avatar.png'}" alt="${request.from_user.display_name}">
        <div class="request-info">
            <h4>${request.from_user.display_name}</h4>
            <p>@${request.from_user.username}</p>
            <small>${request.from_user.about || 'No bio available'}</small>
        </div>
        <div class="request-actions">
            <button class="btn-accept" onclick="acceptContactRequest('${request.id}')">Accept</button>
            <button class="btn-reject" onclick="rejectContactRequest('${request.id}')">Reject</button>
        </div>
    `;
    return div;
}

// Create sent request element
function createSentRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    
    let statusElement = '';
    let actionButton = '';
    
    if (request.status === 'pending') {
        statusElement = '<span class="request-status status-pending">Pending</span>';
        actionButton = `<button class="btn-cancel" onclick="cancelContactRequest('${request.id}')">Cancel</button>`;
    } else if (request.status === 'approved') {
        statusElement = '<span class="request-status status-approved">Accepted</span>';
    } else if (request.status === 'rejected') {
        statusElement = '<span class="request-status status-rejected">Rejected</span>';
    }
    
    div.innerHTML = `
        <img src="${request.to_user.avatar_url || '/default-avatar.png'}" alt="${request.to_user.display_name}">
        <div class="request-info">
            <h4>${request.to_user.display_name}</h4>
            <p>@${request.to_user.username}</p>
            <small>Sent: ${new Date(request.created_at).toLocaleDateString()}</small>
        </div>
        <div class="request-actions">
            ${statusElement}
            ${actionButton}
        </div>
    `;
    return div;
}

// Accept contact request
async function acceptContactRequest(requestId) {
    try {
        // Get request details
        const { data: request, error: requestError } = await supabase
            .from('contact_requests')
            .select('*')
            .eq('id', requestId)
            .single();

        if (requestError) {
            alert('Error fetching request details');
            return;
        }

        // Update request status
        const { error: updateError } = await supabase
            .from('contact_requests')
            .update({ status: 'approved' })
            .eq('id', requestId);

        if (updateError) {
            alert('Failed to accept request: ' + updateError.message);
            return;
        }

        // Add to contacts (both ways)
        const { error: contactError1 } = await supabase
            .from('contacts')
            .insert([
                {
                    owner_id: currentUser.id,
                    contact_id: request.from_user_id,
                    status: 'approved'
                },
                {
                    owner_id: request.from_user_id,
                    contact_id: currentUser.id,
                    status: 'approved'
                }
            ]);

        if (contactError1) {
            console.error('Error adding contacts:', contactError1);
        }

        // Refresh all data
        loadReceivedRequests();
        loadContacts();
        updateRequestCounts();
        
        alert('Contact request accepted!');

    } catch (error) {
        console.error('Error accepting request:', error);
        alert('Failed to accept request');
    }
}

// Reject contact request
async function rejectContactRequest(requestId) {
    try {
        const { error } = await supabase
            .from('contact_requests')
            .update({ status: 'rejected' })
            .eq('id', requestId);

        if (error) {
            alert('Failed to reject request: ' + error.message);
            return;
        }

        loadReceivedRequests();
        updateRequestCounts();
        
        alert('Contact request rejected');

    } catch (error) {
        console.error('Error rejecting request:', error);
        alert('Failed to reject request');
    }
}

// Cancel sent contact request
async function cancelContactRequest(requestId) {
    try {
        const { error } = await supabase
            .from('contact_requests')
            .delete()
            .eq('id', requestId);

        if (error) {
            alert('Failed to cancel request: ' + error.message);
            return;
        }

        loadSentRequests();
        updateRequestCounts();
        
        alert('Contact request cancelled');

    } catch (error) {
        console.error('Error cancelling request:', error);
        alert('Failed to cancel request');
    }
}




// Enhanced groups HTML structure
function updateGroupsTabHTML() {
    const groupsTab = document.getElementById('groups-tab');
    if (groupsTab) {
        groupsTab.innerHTML = `
            <div class="groups-header">
                <div class="groups-nav">
                    <button class="group-nav-btn active" data-group-tab="groups">My Groups</button>
                    <button class="group-nav-btn" data-group-tab="group-requests">Requests (<span id="group-requests-count">0</span>)</button>
                    <button class="group-nav-btn" data-group-tab="sent-group-requests">Sent (<span id="sent-group-requests-count">0</span>)</button>
                </div>
                <div class="group-actions">
                    <button id="create-group-btn" class="btn-primary">
                        <i class="fas fa-plus"></i> Create Group
                    </button>
                    <button id="join-group-btn" class="btn-secondary">
                        <i class="fas fa-sign-in-alt"></i> Join Group
                    </button>
                </div>
            </div>

            <div id="groups-content" class="group-tab-content active">
                <div id="groups-list" class="groups-list"></div>
            </div>

            <div id="group-requests-content" class="group-tab-content">
                <h3>Group Join Requests</h3>
                <div id="group-requests-list" class="requests-list"></div>
            </div>

            <div id="sent-group-requests-content" class="group-tab-content">
                <h3>My Join Requests</h3>
                <div id="sent-group-requests-list" class="requests-list"></div>
            </div>
        `;
    }
}

// Add CSS for groups (similar to contacts but for groups)
function addGroupsCSS() {
    const style = document.createElement('style');
    style.textContent = `
        .groups-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .groups-nav {
            display: flex;
            gap: 10px;
        }

        .group-nav-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .group-nav-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .group-nav-btn:hover {
            background: #f8f9fa;
        }

        .group-nav-btn.active:hover {
            background: #0056b3;
        }

        .group-actions {
            display: flex;
            gap: 10px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .group-tab-content {
            display: none;
        }

        .group-tab-content.active {
            display: block;
        }

        .groups-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .group-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .group-item:hover {
            transform: translateY(-2px);
        }

        .group-item img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin-bottom: 15px;
        }

        .group-info h4 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .group-info p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }

        .group-info small {
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #495057;
        }

        .btn-chat {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .btn-chat:hover {
            background: #0056b3;
        }

        .group-role-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .group-role-badge.admin {
            background: #dc3545;
        }

        .no-groups, .no-requests {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message.own-message {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 0 10px;
        }

        .message-content {
            background: #f1f3f4;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
        }

        .own-message .message-content {
            background: #007bff;
            color: white;
        }

        .message-sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .own-message .message-sender {
            color: rgba(255,255,255,0.8);
        }

        .message-text {
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
        }

        #messages-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
    `;
    document.head.appendChild(style);
}

// Global variables for group auto-refresh
let groupRequestsInterval = null;
let currentGroupTab = 'groups';

// Setup group event listeners
function setupGroupEventListeners() {
    // Group tab navigation
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('group-nav-btn')) {
            switchGroupTab(e.target.dataset.groupTab);
        }
    });

    // Create and join group buttons
    document.addEventListener('click', (e) => {
        if (e.target.id === 'create-group-btn' || e.target.closest('#create-group-btn')) {
            document.getElementById('create-group-modal').style.display = 'flex';
        }
        if (e.target.id === 'join-group-btn' || e.target.closest('#join-group-btn')) {
            document.getElementById('join-group-modal').style.display = 'flex';
        }
    });
}

// Switch between group tabs
function switchGroupTab(tabName) {
    currentGroupTab = tabName;
    
    // Update nav buttons
    document.querySelectorAll('.group-nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-group-tab="${tabName}"]`).classList.add('active');
    
    // Update content
    document.querySelectorAll('.group-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-content`).classList.add('active');
    
    // Load appropriate data
    if (tabName === 'group-requests') {
        loadGroupJoinRequests();
    } else if (tabName === 'sent-group-requests') {
        loadSentGroupJoinRequests();
    }
}

// Start auto-refresh for group requests
function startGroupRequestsAutoRefresh() {
    // Clear existing interval
    if (groupRequestsInterval) {
        clearInterval(groupRequestsInterval);
    }
    
    // Set up fast refresh every 2 seconds
    groupRequestsInterval = setInterval(() => {
        loadGroupJoinRequests();
        loadSentGroupJoinRequests();
        updateGroupRequestCounts();
    }, 2000);
    
    // Initial load
    loadGroupJoinRequests();
    loadSentGroupJoinRequests();
    updateGroupRequestCounts();
}

// Stop group auto-refresh
function stopGroupRequestsAutoRefresh() {
    if (groupRequestsInterval) {
        clearInterval(groupRequestsInterval);
        groupRequestsInterval = null;
    }
}

// Load group join requests (for group admins)
async function loadGroupJoinRequests() {
    try {
        const { data: requests, error } = await supabase
            .from('group_members')
            .select(`
                *,
                user:profiles!group_members_user_id_fkey(*),
                group:groups!group_members_group_id_fkey(*)
            `)
            .eq('status', 'pending')
            .in('group_id', await getAdminGroupIds())
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading group requests:', error);
            return;
        }

        const requestsList = document.getElementById('group-requests-list');
        if (requestsList) {
            requestsList.innerHTML = '';

            if (requests.length === 0) {
                requestsList.innerHTML = '<p class="no-requests">No pending requests</p>';
                return;
            }

            requests.forEach(request => {
                const requestElement = createGroupRequestElement(request);
                requestsList.appendChild(requestElement);
            });
        }

    } catch (error) {
        console.error('Error loading group requests:', error);
    }
}

// Load sent group join requests
async function loadSentGroupJoinRequests() {
    try {
        const { data: requests, error } = await supabase
            .from('group_members')
            .select(`
                *,
                group:groups!group_members_group_id_fkey(*)
            `)
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading sent group requests:', error);
            return;
        }

        const requestsList = document.getElementById('sent-group-requests-list');
        if (requestsList) {
            requestsList.innerHTML = '';

            if (requests.length === 0) {
                requestsList.innerHTML = '<p class="no-requests">No sent requests</p>';
                return;
            }

            requests.forEach(request => {
                const requestElement = createSentGroupRequestElement(request);
                requestsList.appendChild(requestElement);
            });
        }

    } catch (error) {
        console.error('Error loading sent group requests:', error);
    }
}

// Get group IDs where current user is admin
async function getAdminGroupIds() {
    try {
        const { data: adminGroups, error } = await supabase
            .from('groups')
            .select('id')
            .eq('admin_id', currentUser.id);

        if (error) return [];
        return adminGroups.map(group => group.id);
    } catch (error) {
        console.error('Error getting admin groups:', error);
        return [];
    }
}

// Update group request counts
async function updateGroupRequestCounts() {
    try {
        // Get group requests count (for admin groups)
        const adminGroupIds = await getAdminGroupIds();
        const { data: groupRequests, error: groupError } = await supabase
            .from('group_members')
            .select('id', { count: 'exact', head: true })
            .in('group_id', adminGroupIds)
            .eq('status', 'pending');

        // Get sent group requests count
        const { data: sentRequests, error: sentError } = await supabase
            .from('group_members')
            .select('id', { count: 'exact', head: true })
            .eq('user_id', currentUser.id);

        if (!groupError) {
            const requestCount = groupRequests || 0;
            const countElement = document.getElementById('group-requests-count');
            if (countElement) {
                countElement.textContent = requestCount;
            }
        }

        if (!sentError) {
            const sentCount = sentRequests || 0;
            const sentCountElement = document.getElementById('sent-group-requests-count');
            if (sentCountElement) {
                sentCountElement.textContent = sentCount;
            }
        }

    } catch (error) {
        console.error('Error updating group request counts:', error);
    }
}

// Create group request element
function createGroupRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    div.innerHTML = `
        <img src="${request.user.avatar_url || '/default-avatar.png'}" alt="${request.user.display_name}">
        <div class="request-info">
            <h4>${request.user.display_name}</h4>
            <p>@${request.user.username}</p>
            <small>Wants to join: <strong>${request.group.name}</strong></small>
        </div>
        <div class="request-actions">
            <button class="btn-accept" onclick="approveGroupJoinRequest('${request.id}')">Approve</button>
            <button class="btn-reject" onclick="rejectGroupJoinRequest('${request.id}')">Reject</button>
        </div>
    `;
    return div;
}

// Create sent group request element
function createSentGroupRequestElement(request) {
    const div = document.createElement('div');
    div.className = 'request-item';
    
    let statusElement = '';
    let actionButton = '';
    
    if (request.status === 'pending') {
        statusElement = '<span class="request-status status-pending">Pending</span>';
        actionButton = `<button class="btn-cancel" onclick="cancelGroupJoinRequest('${request.id}')">Cancel</button>`;
    } else if (request.status === 'approved') {
        statusElement = '<span class="request-status status-approved">Approved</span>';
    } else if (request.status === 'rejected') {
        statusElement = '<span class="request-status status-rejected">Rejected</span>';
    }
    
    div.innerHTML = `
        <img src="${request.group.avatar_url || '/default-group.png'}" alt="${request.group.name}">
        <div class="request-info">
            <h4>${request.group.name}</h4>
            <p>Code: ${request.group.group_code}</p>
            <small>Requested: ${new Date(request.created_at).toLocaleDateString()}</small>
        </div>
        <div class="request-actions">
            ${statusElement}
            ${actionButton}
        </div>
    `;
    return div;
}

// Approve group join request
async function approveGroupJoinRequest(requestId) {
    try {
        const { error } = await supabase
            .from('group_members')
            .update({ status: 'approved' })
            .eq('id', requestId);

        if (error) {
            alert('Failed to approve request: ' + error.message);
            return;
        }

        loadGroupJoinRequests();
        loadGroups(); // Refresh groups list
        updateGroupRequestCounts();
        
        alert('Member approved!');

    } catch (error) {
        console.error('Error approving group request:', error);
        alert('Failed to approve request');
    }
}

// Reject group join request
async function rejectGroupJoinRequest(requestId) {
    try {
        const { error } = await supabase
            .from('group_members')
            .update({ status: 'rejected' })
            .eq('id', requestId);

        if (error) {
            alert('Failed to reject request: ' + error.message);
            return;
        }

        loadGroupJoinRequests();
        updateGroupRequestCounts();
        
        alert('Request rejected');

    } catch (error) {
        console.error('Error rejecting group request:', error);
        alert('Failed to reject request');
    }
}

// Cancel sent group join request
async function cancelGroupJoinRequest(requestId) {
    try {
        const { error } = await supabase
            .from('group_members')
            .delete()
            .eq('id', requestId);

        if (error) {
            alert('Failed to cancel request: ' + error.message);
            return;
        }

        loadSentGroupJoinRequests();
        updateGroupRequestCounts();
        
        alert('Request cancelled');

    } catch (error) {
        console.error('Error cancelling group request:', error);
        alert('Failed to cancel request');
    }
}

// Enhanced loadGroups function with role display
async function loadGroups() {
    try {
        const { data: groups, error } = await supabase
            .from('group_members')
            .select(`
                *,
                group:groups(*)
            `)
            .eq('user_id', currentUser.id)
            .eq('status', 'approved');

        if (error) {
            console.error('Error loading groups:', error);
            return;
        }

        const groupsList = document.getElementById('groups-list');
        if (groupsList) {
            groupsList.innerHTML = '';

            if (groups.length === 0) {
                groupsList.innerHTML = '<p class="no-groups">No groups yet. Create or join one!</p>';
                return;
            }

            groups.forEach(groupMember => {
                const groupElement = createEnhancedGroupElement(groupMember.group, groupMember.role);
                groupsList.appendChild(groupElement);
            });
        }

    } catch (error) {
        console.error('Error loading groups:', error);
    }
}

// Enhanced group element with role display
function createEnhancedGroupElement(group, role) {
    const div = document.createElement('div');
    div.className = 'group-item';
    div.innerHTML = `
        <img src="${group.avatar_url || '/default-group.png'}" alt="${group.name}">
        <div class="group-info">
            <h4>${group.name} <span class="group-role-badge ${role}">${role}</span></h4>
            <p>${group.description || 'No description'}</p>
            <small>Code: ${group.group_code}</small>
        </div>
        <button class="btn-chat" onclick="openGroup('${group.id}')">
            <i class="fas fa-comments"></i> Open Chat
        </button>
    `;
    return div;
}


// ADD these CSS rules for the chat interface (add to your existing CSS or create new style tag)
function addChatCSS() {
    const style = document.createElement('style');
    style.textContent = `
        #chat-screen {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }

        .chat-header-info h3 {
            margin: 0;
            font-size: 18px;
        }

        .chat-header-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-input-container {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 45px;
        }

        #send-btn {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #send-btn:hover {
            background: #0056b3;
        }

        #send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            margin-right: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            background: #f8f9fa;
        }

        .typing-indicator {
            display: none;
            padding: 10px 0;
            color: #666;
            font-style: italic;
            font-size: 14px;
        }

        .online-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-left: 8px;
        }

        .offline-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #6c757d;
            border-radius: 50%;
            margin-left: 8px;
        }
    `;
    document.head.appendChild(style);
}



function ensureChatHTML() {
    const chatScreen = document.getElementById('chat-screen');
    if (chatScreen && !chatScreen.querySelector('.chat-header')) {
        chatScreen.innerHTML = `
            <div class="chat-header">
                <button id="back-btn" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <img id="chat-header-avatar" src="/default-avatar.png" alt="Chat Avatar">
                <div class="chat-header-info">
                    <h3 id="chat-header-name">Chat Name</h3>
                    <p id="chat-header-status">Status</p>
                </div>
            </div>
            
            <div class="chat-messages">
                <div id="messages-container"></div>
                <div class="typing-indicator" id="typing-indicator">
                    Someone is typing...
                </div>
            </div>
            
            <div class="chat-input-container">
                <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
                <button id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        `;
    }
}


    </script>
</body>
</html>
