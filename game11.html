<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* CSS will be in styles.css */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-chat: #e5ddd5;
            --text-primary: #111b21;
            --text-secondary: #667781;
            --accent: #00a884;
            --accent-hover: #017561;
            --border: #e9edef;
            --message-sent: #d9fdd3;
            --message-received: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #111b21;
            --bg-secondary: #202c33;
            --bg-chat: #0b141a;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --border: #313a42;
            --message-sent: #005c4b;
            --message-received: #202c33;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        .screen {
            display: none;
            height: 100vh;
        }

        .screen.active {
            display: flex;
        }

        /* Auth Screen */
        #auth-screen {
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, var(--accent), #128c7e);
        }

        .auth-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo i {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .logo h1 {
            color: var(--text-primary);
            font-weight: 300;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .auth-btn, .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background: var(--accent);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auth-btn:hover, .btn:hover {
            background: var(--accent-hover);
        }

        .btn.primary {
            background: var(--accent);
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        /* Main App */
        #app-screen {
            background: var(--bg-primary);
        }

        .sidebar {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar.large {
            width: 80px;
            height: 80px;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .icon-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-container {
            position: relative;
            padding: 1rem;
        }

        .search-container input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-icon {
            position: absolute;
            left: 1.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item, .contact-item, .user-search-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            border-bottom: 1px solid var(--border);
        }

        .chat-item:hover, .contact-item:hover, .user-search-item:hover {
            background: var(--bg-primary);
        }

        .chat-info, .contact-info, .user-info {
            flex: 1;
            margin-left: 0.75rem;
        }

        .chat-name, .contact-name, .user-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .last-message, .contact-username, .user-username {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .chat-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .unread-count {
            background: var(--accent);
            color: white;
            border-radius: 10px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            min-width: 20px;
            text-align: center;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-chat);
        }

        .welcome-content {
            text-align: center;
            color: var(--text-secondary);
        }

        .welcome-content i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-details {
            display: flex;
            flex-direction: column;
        }

        .chat-name {
            font-weight: 500;
        }

        .status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .messages-container {
            flex: 1;
            background: var(--bg-chat);
            overflow-y: auto;
            padding: 1rem;
        }

        .message {
            margin-bottom: 0.5rem;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            position: relative;
        }

        .message.sent .message-content {
            background: var(--message-sent);
            border-bottom-right-radius: 2px;
        }

        .message.received .message-content {
            background: var(--message-received);
            border-bottom-left-radius: 2px;
        }

        .message-text {
            word-wrap: break-word;
        }

        .message-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.25rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .typing-indicator {
            padding: 1rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .message-composer {
            padding: 1rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        .send-btn:hover {
            background: var(--accent-hover);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 4px 20px var(--shadow);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1rem;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .contacts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .qr-section {
            text-align: center;
            padding: 1rem 0;
        }

        .qr-section canvas {
            margin: 1rem 0;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-area {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="screen active">
        <div class="auth-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <h1>SecureChat</h1>
            </div>
            
            <div class="auth-tabs">
                <button class="tab-btn active" data-tab="login">Login</button>
                <button class="tab-btn" data-tab="register">Register</button>
            </div>
            
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <input type="email" id="login-email" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-password" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-btn">Login</button>
            </form>
            
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <input type="text" id="register-username" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="text" id="register-name" placeholder="Display Name" required>
                </div>
                <div class="form-group">
                    <input type="email" id="register-email" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="register-password" placeholder="Password" required>
                </div>
                <button type="submit" class="auth-btn">Register</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="screen">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <img id="user-avatar" src="https://via.placeholder.com/40" alt="Avatar" class="avatar">
                    <span id="user-name">User</span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="new-chat-btn"><i class="fas fa-plus"></i></button>
                    <button class="icon-btn" id="settings-btn"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Search chats...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="chat-list" id="chat-list">
                <!-- Chat items will be populated here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="welcome-screen" id="welcome-screen">
                <div class="welcome-content">
                    <i class="fas fa-comments"></i>
                    <h2>Welcome to SecureChat</h2>
                    <p>Select a chat to start messaging securely</p>
                </div>
            </div>
            
            <div class="chat-container" id="chat-container" style="display: none;">
                <div class="chat-header">
                    <div class="chat-info">
                        <img id="chat-avatar" src="https://via.placeholder.com/40" alt="Avatar" class="avatar">
                        <div class="chat-details">
                            <span id="chat-name">Chat Name</span>
                            <span id="chat-status" class="status">last seen recently</span>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="icon-btn"><i class="fas fa-video"></i></button>
                        <button class="icon-btn"><i class="fas fa-phone"></i></button>
                        <button class="icon-btn" id="chat-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>
                
                <div class="messages-container" id="messages-container">
                    <div id="messages-list">
                        <!-- Messages will be populated here -->
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <span>Someone is typing...</span>
                </div>
                
                <div class="message-composer">
                    <button class="icon-btn" id="attach-btn"><i class="fas fa-paperclip"></i></button>
                    <div class="input-container">
                        <input type="text" id="message-input" placeholder="Type a message...">
                        <button class="icon-btn" id="emoji-btn"><i class="fas fa-smile"></i></button>
                    </div>
                    <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
                    <input type="file" id="file-input" multiple style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay">
        <!-- New Chat Modal -->
        <div id="new-chat-modal" class="modal">
            <div class="modal-header">
                <h3>New Chat</h3>
                <button class="close-btn" data-modal="new-chat-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="contacts">Contacts</button>
                    <button class="tab-btn" data-tab="add-contact">Add Contact</button>
                </div>
                
                <div id="contacts-tab" class="tab-content active">
                    <div class="search-container">
                        <input type="text" id="contact-search" placeholder="Search contacts...">
                    </div>
                    <div id="contacts-list" class="contacts-list">
                        <!-- Contacts will be populated here -->
                    </div>
                </div>
                
                <div id="add-contact-tab" class="tab-content">
                    <input type="text" id="username-search" placeholder="Enter username">
                    <button id="search-user-btn" class="btn">Search</button>
                    <div id="user-search-results"></div>
                    
                    <hr>
                    
                    <div class="qr-section">
                        <h4>Share your QR Code</h4>
                        <div id="qr-code"></div>
                        <button id="scan-qr-btn" class="btn">Scan QR Code</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-btn" data-modal="settings-modal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Profile Picture</label>
                    <div class="avatar-upload">
                        <img id="settings-avatar" src="https://via.placeholder.com/80" alt="Avatar" class="avatar large">
                        <button id="upload-avatar-btn" class="btn">Change</button>
                        <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>Display Name</label>
                    <input type="text" id="settings-name" placeholder="Your name">
                </div>
                
                <div class="setting-group">
                    <label>About</label>
                    <textarea id="settings-about" placeholder="About yourself..."></textarea>
                </div>
                
                <div class="setting-group">
                    <label>Theme</label>
                    <select id="theme-select">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                
                <div class="setting-group">
                    <button id="save-settings-btn" class="btn primary">Save Changes</button>
                    <button id="logout-btn" class="btn danger">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.9/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/9.0.0/uuid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    
    <script>
        // Supabase initialization
        const SUPABASE_URL = 'https://nsnacwwcrszpjmanskti.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zbmFjd3djcnN6cGptYW5za3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTg2MTIsImV4cCI6MjA2ODQ5NDYxMn0.W01JADzAuGFvcAHAN6LPRIxc75J7A9Q76HIxvxkJDn4';
       let supabase;
        
        function initializeSupabase() {
            try {
                console.log("Initializing Supabase client...");
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                return true;
            } catch (e) { 
                console.error("Error initializing Supabase client:", e); 
                return false; 
            }
        }

        // Global state
        let currentUser = null;
        let currentChat = null;
        let userKeyPair = null;
        let chatKeys = new Map(); // chat_id -> symmetric key
        let contacts = new Map();
        let chats = new Map();
        let realtimeChannels = new Map();
        let typingTimeouts = new Map();

        // Crypto utilities
        function generateKeyPair() {
            return nacl.box.keyPair();
        }

        function generateSymmetricKey() {
            return nacl.randomBytes(32);
        }

        function encryptMessage(message, key) {
            const nonce = nacl.randomBytes(24);
            const messageBytes = new TextEncoder().encode(message);
            const encrypted = nacl.secretbox(messageBytes, nonce, key);
            return {
                cipher: Array.from(encrypted),
                nonce: Array.from(nonce)
            };
        }

        function decryptMessage(encryptedData, key) {
            try {
                const cipher = new Uint8Array(encryptedData.cipher);
                const nonce = new Uint8Array(encryptedData.nonce);
                const decrypted = nacl.secretbox.open(cipher, nonce, key);
                if (!decrypted) return null;
                return new TextDecoder().decode(decrypted);
            } catch (e) {
                console.error('Decryption failed:', e);
                return null;
            }
        }

        function deriveSharedKey(theirPublicKey, myPrivateKey) {
            const theirKey = new Uint8Array(atob(theirPublicKey).split('').map(c => c.charCodeAt(0)));
            return nacl.box.before(theirKey, myPrivateKey);
        }

        // Utility functions
        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            // Simple error display - could be enhanced with a toast system
            alert(message);
        }

        function formatTime(timestamp) {
            return dayjs(timestamp).format('HH:mm');
        }

        function formatDate(timestamp) {
            const date = dayjs(timestamp);
            const now = dayjs();
            
            if (date.isSame(now, 'day')) return 'Today';
            if (date.isSame(now.subtract(1, 'day'), 'day')) return 'Yesterday';
            if (date.isSame(now, 'week')) return date.format('dddd');
            return date.format('MM/DD/YYYY');
        }

        // IndexedDB cache
        class CacheManager {
            constructor() {
                this.dbName = 'SecureChatCache';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('chats')) {
                            db.createObjectStore('chats', { keyPath: 'id' });
                        }
                        
                        if (!db.objectStoreNames.contains('messages')) {
                            const messageStore = db.createObjectStore('messages', { keyPath: 'id' });
                            messageStore.createIndex('chat_id', 'chat_id');
                        }
                        
                        if (!db.objectStoreNames.contains('keys')) {
                            db.createObjectStore('keys', { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveKeys(keys) {
                const transaction = this.db.transaction(['keys'], 'readwrite');
                const store = transaction.objectStore('keys');
                await store.put({ id: 'userKeys', ...keys });
            }

            async loadKeys() {
                const transaction = this.db.transaction(['keys'], 'readonly');
                const store = transaction.objectStore('keys');
                const result = await store.get('userKeys');
                return result;
            }
        }

        const cache = new CacheManager();

        // Authentication
        class AuthManager {
            async login(email, password) {
                showLoading();
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    await this.loadUserProfile();
                    await this.loadOrGenerateKeys();
                    return true;
                } catch (error) {
                    showError(error.message);
                    return false;
                } finally {
                    showLoading(false);
                }
            }

            async register(username, displayName, email, password) {
                showLoading();
                try {
                    // Generate keypair for E2E encryption
                    const keyPair = generateKeyPair();
                    const publicKeyB64 = btoa(String.fromCharCode(...keyPair.publicKey));
                    
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                    
                    // Create profile
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert({
                            id: data.user.id,
                            username,
                            display_name: displayName,
                            public_key: publicKeyB64
                        });
                    
                    if (profileError) throw profileError;
                    
                    // Store keys locally
                    userKeyPair = keyPair;
                    await cache.saveKeys({
                        publicKey: Array.from(keyPair.publicKey),
                        secretKey: Array.from(keyPair.secretKey)
                    });
                    
                    await this.loadUserProfile();
                    return true;
                } catch (error) {
                    showError(error.message);
                    return false;
                } finally {
                    showLoading(false);
                }
            }

            async loadUserProfile() {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                currentUser = { ...user, ...profile };
                this.updateUI();
            }

            async loadOrGenerateKeys() {
                let keys = await cache.loadKeys();
                
                if (!keys) {
                    // Generate new keys if not found
                    userKeyPair = generateKeyPair();
                    await cache.saveKeys({
                        publicKey: Array.from(userKeyPair.publicKey),
                        secretKey: Array.from(userKeyPair.secretKey)
                    });
                } else {
                    userKeyPair = {
                        publicKey: new Uint8Array(keys.publicKey),
                        secretKey: new Uint8Array(keys.secretKey)
                    };
                }
            }

            updateUI() {
                document.getElementById('user-name').textContent = currentUser.display_name;
                document.getElementById('user-avatar').src = currentUser.avatar_url || 'https://via.placeholder.com/40';
                document.getElementById('settings-name').value = currentUser.display_name;
                document.getElementById('settings-about').value = currentUser.about || '';
                document.getElementById('settings-avatar').src = currentUser.avatar_url || 'https://via.placeholder.com/80';
            }

            async logout() {
                await supabase.auth.signOut();
                currentUser = null;
                userKeyPair = null;
                chatKeys.clear();
                this.showAuthScreen();
            }

            showAuthScreen() {
                document.getElementById('auth-screen').classList.add('active');
                document.getElementById('app-screen').classList.remove('active');
            }

            showAppScreen() {
                document.getElementById('auth-screen').classList.remove('active');
                document.getElementById('app-screen').classList.add('active');
            }
        }

        const auth = new AuthManager();

        // Chat Manager
        class ChatManager {
            async loadChats() {
                const { data: chatMembers } = await supabase
                    .from('chat_members')
                    .select(`
                        chat_id,
                        chats (
                            id,
                            type,
                            title,
                            avatar_url,
                            created_at,
                            updated_at
                        )
                    `)
                    .eq('user_id', currentUser.id);

                for (const member of chatMembers || []) {
                    const chat = member.chats;
                    chats.set(chat.id, chat);
                    
                    // Load chat key or derive it
                    await this.loadChatKey(chat.id);
                }

                this.renderChatList();
            }

            async loadChatKey(chatId) {
                // For DM chats, derive key from other participant's public key
                // For groups, could use a shared key exchange mechanism
                // Simplified implementation here
                
                if (!chatKeys.has(chatId)) {
                    // Generate a temporary key for demo purposes
                    // In production, implement proper key exchange
                    const key = generateSymmetricKey();
                    chatKeys.set(chatId, key);
                }
            }

            async createDMChat(contactId) {
                try {
                    // Check if DM already exists
                    const { data: existingChat } = await supabase
                        .from('chat_members')
                        .select('chat_id, chats(*)')
                        .eq('user_id', currentUser.id)
                        .in('chat_id', 
                            supabase.from('chat_members')
                                .select('chat_id')
                                .eq('user_id', contactId)
                        );

                    if (existingChat && existingChat.length > 0) {
                        const dmChat = existingChat.find(c => c.chats.type === 'dm');
                        if (dmChat) {
                            this.openChat(dmChat.chat_id);
                            return;
                        }
                    }

                    // Create new DM
                    const { data: chat, error } = await supabase
                        .from('chats')
                        .insert({
                            type: 'dm',
                            created_by: currentUser.id
                        })
                        .select()
                        .single();

                    if (error) throw error;

                    // Add members
                    await supabase
                        .from('chat_members')
                        .insert([
                            { chat_id: chat.id, user_id: currentUser.id },
                            { chat_id: chat.id, user_id: contactId }
                        ]);

                    chats.set(chat.id, chat);
                    await this.loadChatKey(chat.id);
                    this.renderChatList();
                    this.openChat(chat.id);
                } catch (error) {
                    showError('Failed to create chat: ' + error.message);
                }
            }

            renderChatList() {
                const chatList = document.getElementById('chat-list');
                chatList.innerHTML = '';

                for (const [chatId, chat] of chats) {
                    const item = document.createElement('div');
                    item.className = 'chat-item';
                    item.onclick = () => this.openChat(chatId);
                    
                    item.innerHTML = `
                        <img src="${chat.avatar_url || 'https://via.placeholder.com/50'}" alt="Avatar" class="avatar">
                        <div class="chat-info">
                            <div class="chat-name">${chat.title || 'Direct Message'}</div>
                            <div class="last-message">Last message preview...</div>
                        </div>
                        <div class="chat-meta">
                            <span class="time">${formatTime(chat.updated_at)}</span>
                            <span class="unread-count">3</span>
                        </div>
                    `;
                    
                    chatList.appendChild(item);
                }
            }

            async openChat(chatId) {
                currentChat = chatId;
                
                // Update UI
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('chat-container').style.display = 'flex';
                
                // Load chat details
                const chat = chats.get(chatId);
                document.getElementById('chat-name').textContent = chat.title || 'Direct Message';
                
                // Setup realtime
                this.setupRealtimeChannel(chatId);
                
                // Load messages
                await this.loadMessages(chatId);
            }

            setupRealtimeChannel(chatId) {
                // Clean up existing channel
                if (realtimeChannels.has(chatId)) {
                    realtimeChannels.get(chatId).unsubscribe();
                }

                const channel = supabase
                    .channel(`chat-${chatId}`)
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'messages',
                            filter: `chat_id=eq.${chatId}`
                        }, 
                        (payload) => this.handleNewMessage(payload.new)
                    )
                    .on('presence', { event: 'sync' }, () => {
                        // Handle presence updates
                    })
                    .subscribe();

                realtimeChannels.set(chatId, channel);
            }

            async loadMessages(chatId) {
                const { data: messages } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('chat_id', chatId)
                    .order('created_at', { ascending: true })
                    .limit(50);

                this.renderMessages(messages || []);
            }

            renderMessages(messages) {
                const messagesList = document.getElementById('messages-list');
                messagesList.innerHTML = '';

                for (const message of messages) {
                    const decryptedContent = this.decryptMessage(message);
                    const messageEl = this.createMessageElement(message, decryptedContent);
                    messagesList.appendChild(messageEl);
                }

                messagesList.scrollTop = messagesList.scrollHeight;
            }

            decryptMessage(message) {
                const chatKey = chatKeys.get(message.chat_id);
                if (!chatKey) return 'Decryption failed';
                
                try {
                    const encryptedData = JSON.parse(message.body_cipher);
                    return decryptMessage(encryptedData, chatKey);
                } catch (error) {
                    console.error('Message decryption failed:', error);
                    return 'Decryption failed';
                }
            }

            createMessageElement(message, content) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.sender_id === currentUser.id ? 'sent' : 'received'}`;
                
                messageEl.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${this.escapeHtml(content)}</div>
                        <div class="message-meta">
                            <span class="message-time">${formatTime(message.created_at)}</span>
                            ${message.sender_id === currentUser.id ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                `;
                
                return messageEl;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async sendMessage(content) {
                if (!currentChat || !content.trim()) return;

                const chatKey = chatKeys.get(currentChat);
                if (!chatKey) {
                    showError('Chat key not available');
                    return;
                }

                try {
                    const encryptedContent = encryptMessage(content.trim(), chatKey);
                    
                    const { error } = await supabase
                        .from('messages')
                        .insert({
                            chat_id: currentChat,
                            sender_id: currentUser.id,
                            body_cipher: JSON.stringify(encryptedContent)
                        });

                    if (error) throw error;
                    
                    // Clear input
                    document.getElementById('message-input').value = '';
                } catch (error) {
                    showError('Failed to send message: ' + error.message);
                }
            }

            handleNewMessage(message) {
                if (message.chat_id === currentChat) {
                    const decryptedContent = this.decryptMessage(message);
                    const messageEl = this.createMessageElement(message, decryptedContent);
                    document.getElementById('messages-list').appendChild(messageEl);
                    document.getElementById('messages-list').scrollTop = document.getElementById('messages-list').scrollHeight;
                }
            }
        }

        const chatManager = new ChatManager();

        // Contact Manager
        class ContactManager {
            async loadContacts() {
                const { data: contactsData } = await supabase
                    .from('contacts')
                    .select(`
                        contact_id,
                        alias,
                        profiles (
                            id,
                            username,
                            display_name,
                            avatar_url,
                            public_key
                        )
                    `)
                    .eq('owner_id', currentUser.id);

                contacts.clear();
                for (const contact of contactsData || []) {
                    contacts.set(contact.contact_id, {
                        ...contact.profiles,
                        alias: contact.alias
                    });
                }

                this.renderContacts();
            }

            renderContacts() {
                const contactsList = document.getElementById('contacts-list');
                contactsList.innerHTML = '';

                for (const [contactId, contact] of contacts) {
                    const item = document.createElement('div');
                    item.className = 'contact-item';
                    item.onclick = () => chatManager.createDMChat(contactId);
                    
                    item.innerHTML = `
                        <img src="${contact.avatar_url || 'https://via.placeholder.com/40'}" alt="Avatar" class="avatar">
                        <div class="contact-info">
                            <div class="contact-name">${contact.alias || contact.display_name}</div>
                            <div class="contact-username">@${contact.username}</div>
                        </div>
                    `;
                    
                    contactsList.appendChild(item);
                }
            }

            async searchUser(username) {
                const { data: users } = await supabase
                    .from('profiles')
                    .select('*')
                    .ilike('username', `%${username}%`)
                    .neq('id', currentUser.id)
                    .limit(10);

                this.renderUserSearchResults(users || []);
            }

            renderUserSearchResults(users) {
                const resultsEl = document.getElementById('user-search-results');
                resultsEl.innerHTML = '';

                for (const user of users) {
                    const item = document.createElement('div');
                    item.className = 'user-search-item';
                    
                    item.innerHTML = `
                        <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" alt="Avatar" class="avatar">
                        <div class="user-info">
                            <div class="user-name">${user.display_name}</div>
                            <div class="user-username">@${user.username}</div>
                        </div>
                        <button class="btn" onclick="contactManager.addContact('${user.id}')">Add</button>
                    `;
                    
                    resultsEl.appendChild(item);
                }
            }

            async addContact(userId) {
                try {
                    const { error } = await supabase
                        .from('contacts')
                        .insert({
                            owner_id: currentUser.id,
                            contact_id: userId
                        });

                    if (error) throw error;
                    
                    await this.loadContacts();
                    showError('Contact added successfully!');
                } catch (error) {
                    showError('Failed to add contact: ' + error.message);
                }
            }

            generateQRCode() {
                const qrData = JSON.stringify({
                    type: 'contact',
                    userId: currentUser.id,
                    username: currentUser.username
                });
                
                QRCode.toCanvas(document.getElementById('qr-code'), qrData, {
                    width: 200,
                    margin: 2
                });
            }
        }

        const contactManager = new ContactManager();

        // File Manager
        class FileManager {
            async uploadFile(file) {
                try {
                    showLoading();
                    
                    // Encrypt file before upload
                    const fileBuffer = await file.arrayBuffer();
                    const fileKey = generateSymmetricKey();
                    
                    // Simple file encryption (in production, use streaming encryption)
                    const nonce = nacl.randomBytes(24);
                    const encrypted = nacl.secretbox(new Uint8Array(fileBuffer), nonce, fileKey);
                    
                    const fileName = `${uuidv4()}.encrypted`;
                    
                    const { data, error } = await supabase.storage
                        .from('attachments')
                        .upload(fileName, encrypted);

                    if (error) throw error;

                    return {
                        path: data.path,
                        originalName: file.name,
                        size: file.size,
                        type: file.type,
                        key: Array.from(fileKey),
                        nonce: Array.from(nonce)
                    };
                } catch (error) {
                    showError('Failed to upload file: ' + error.message);
                    return null;
                } finally {
                    showLoading(false);
                }
            }

            async downloadFile(attachment) {
                try {
                    const { data, error } = await supabase.storage
                        .from('attachments')
                        .download(attachment.path);

                    if (error) throw error;

                    const encrypted = new Uint8Array(await data.arrayBuffer());
                    const fileKey = new Uint8Array(attachment.key);
                    const nonce = new Uint8Array(attachment.nonce);
                    
                    const decrypted = nacl.secretbox.open(encrypted, nonce, fileKey);
                    if (!decrypted) throw new Error('Decryption failed');

                    const blob = new Blob([decrypted], { type: attachment.type });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = attachment.originalName;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                } catch (error) {
                    showError('Failed to download file: ' + error.message);
                }
            }
        }

        const fileManager = new FileManager();

        // Theme Manager
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'light';
                this.applyTheme();
            }

            applyTheme() {
                document.body.setAttribute('data-theme', this.currentTheme);
                const themeSelect = document.getElementById('theme-select');
                if (themeSelect) themeSelect.value = this.currentTheme;
            }

            setTheme(theme) {
                this.currentTheme = theme;
                localStorage.setItem('theme', theme);
                this.applyTheme();
            }
        }

        const themeManager = new ThemeManager();

        // Initialize app
        async function initApp() {
            if (!initializeSupabase()) {
                showError('Failed to initialize Supabase');
                return;
            }

            await cache.init();

            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await auth.loadUserProfile();
                await auth.loadOrGenerateKeys();
                auth.showAppScreen();
                await chatManager.loadChats();
                await contactManager.loadContacts();
                contactManager.generateQRCode();
            }

            setupEventListeners();
        }

        function setupEventListeners() {
            // Auth form handling
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (await auth.login(email, password)) {
                    auth.showAppScreen();
                    await chatManager.loadChats();
                    await contactManager.loadContacts();
                    contactManager.generateQRCode();
                }
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                
                if (await auth.register(username, name, email, password)) {
                    auth.showAppScreen();
                    await chatManager.loadChats();
                    await contactManager.loadContacts();
                    contactManager.generateQRCode();
                }
            });

            // Auth tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tab = e.target.dataset.tab;
                    if (tab === 'login' || tab === 'register') {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                        e.target.classList.add('active');
                        document.getElementById(`${tab}-form`).classList.add('active');
                    }
                });
            });

            // Message sending
            document.getElementById('send-btn').addEventListener('click', () => {
                const input = document.getElementById('message-input');
                chatManager.sendMessage(input.value);
            });

            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    chatManager.sendMessage(e.target.value);
                }
            });

            // File attachment
            document.getElementById('attach-btn').addEventListener('click', () => {
                document.getElementById('file-input').click();
            });

            document.getElementById('file-input').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const attachment = await fileManager.uploadFile(file);
                    if (attachment) {
                        // Send attachment message
                        const attachmentMessage = {
                            type: 'attachment',
                            attachment: attachment
                        };
                        chatManager.sendMessage(JSON.stringify(attachmentMessage));
                    }
                }
                e.target.value = '';
            });

            // Modal handling
            document.getElementById('new-chat-btn').addEventListener('click', () => {
                showModal('new-chat-modal');
            });

            document.getElementById('settings-btn').addEventListener('click', () => {
                showModal('settings-modal');
            });

            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    hideModal(e.target.dataset.modal);
                });
            });

            // Modal tab switching
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn') && e.target.dataset.tab) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        modal.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        e.target.classList.add('active');
                        modal.querySelector(`#${e.target.dataset.tab}-tab`).classList.add('active');
                    }
                }
            });

            // Contact search
            document.getElementById('search-user-btn').addEventListener('click', () => {
                const username = document.getElementById('username-search').value;
                if (username.trim()) {
                    contactManager.searchUser(username.trim());
                }
            });

            // Settings
            document.getElementById('save-settings-btn').addEventListener('click', async () => {
                const name = document.getElementById('settings-name').value;
                const about = document.getElementById('settings-about').value;
                
                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({
                            display_name: name,
                            about: about
                        })
                        .eq('id', currentUser.id);

                    if (error) throw error;
                    
                    currentUser.display_name = name;
                    currentUser.about = about;
                    auth.updateUI();
                    hideModal('settings-modal');
                    showError('Settings saved successfully!');
                } catch (error) {
                    showError('Failed to save settings: ' + error.message);
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                auth.logout();
            });

            document.getElementById('theme-select').addEventListener('change', (e) => {
                themeManager.setTheme(e.target.value);
            });

            // Avatar upload
            document.getElementById('upload-avatar-btn').addEventListener('click', () => {
                document.getElementById('avatar-input').click();
            });

            document.getElementById('avatar-input').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const fileName = `avatar-${currentUser.id}-${Date.now()}`;
                        const { data, error } = await supabase.storage
                            .from('avatars')
                            .upload(fileName, file);

                        if (error) throw error;

                        const { data: { publicUrl } } = supabase.storage
                            .from('avatars')
                            .getPublicUrl(fileName);

                        await supabase
                            .from('profiles')
                            .update({ avatar_url: publicUrl })
                            .eq('id', currentUser.id);

                        currentUser.avatar_url = publicUrl;
                        auth.updateUI();
                    } catch (error) {
                        showError('Failed to upload avatar: ' + error.message);
                    }
                }
            });

            // Search functionality
            document.getElementById('search-input').addEventListener('input', _.debounce((e) => {
                const query = e.target.value.toLowerCase();
                const chatItems = document.querySelectorAll('.chat-item');
                
                chatItems.forEach(item => {
                    const name = item.querySelector('.chat-name').textContent.toLowerCase();
                    item.style.display = name.includes(query) ? 'flex' : 'none';
                });
            }, 300));

            document.getElementById('contact-search').addEventListener('input', _.debounce((e) => {
                const query = e.target.value.toLowerCase();
                const contactItems = document.querySelectorAll('.contact-item');
                
                contactItems.forEach(item => {
                    const name = item.querySelector('.contact-name').textContent.toLowerCase();
                    const username = item.querySelector('.contact-username').textContent.toLowerCase();
                    item.style.display = (name.includes(query) || username.includes(query)) ? 'flex' : 'none';
                });
            }, 300));

            // Typing indicator
            let typingTimer;
            document.getElementById('message-input').addEventListener('input', () => {
                if (currentChat) {
                    clearTimeout(typingTimer);
                    // Send typing indicator
                    typingTimer = setTimeout(() => {
                        // Stop typing indicator
                    }, 1000);
                }
            });
        }

        function showModal(modalId) {
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById(modalId).style.display = 'block';
        }

        function hideModal(modalId) {
            document.getElementById('modal-overlay').style.display = 'none';
            if (modalId) {
                document.getElementById(modalId).style.display = 'none';
            } else {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            }
        }

        // Handle auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_OUT') {
                auth.showAuthScreen();
            }
        });

        // Start the app
        initApp();
    </script>

    
